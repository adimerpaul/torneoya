import{_ as P,c as T,o as r,w as a,a as n,b as e,Q as f,e as h,f as c,aq as m,a5 as u,a6 as b,a7 as x,t as s,a1 as C,d as E,Z as V,aB as y,h as S,a4 as D}from"./index-lPAR6Jhh.js";import{Q as _}from"./QSpace-CQPUmHlq.js";import{Q as U}from"./QPagination-D095xCo7.js";import{Q as N}from"./QImg-D1sKr7CE.js";import{Q as w}from"./QMarkupTable-CioHdnf4.js";import{Q as k}from"./QForm-BUxmvV0f.js";import{Q as I}from"./QSelect-CbWjc70L.js";import{Q as q}from"./QPage-DE3LyCWt.js";import{I as Q}from"./Imprimir--3wAIWou.js";import"./format-BvkBI9bc.js";import"./QItemLabel-nqG76Yrv.js";import"./QMenu-B-B1QStO.js";import"./rtl-DFPa-2ov.js";import"./_commonjsHelpers-gnU0ypJ3.js";import"./moment-C5S46NFB.js";const L={name:"VentasNew",data(){return{codigoTipoDocumentoIdentidades:[{value:1,label:"CI - CEDULA DE IDENTIDAD"},{value:2,label:"CEX - CED ULA DE IDENTIDAD DE EXTRANJERO"},{value:5,label:"NIT - NÚMERO DE IDENTIFICACIÓN TRIBUTARIA"},{value:3,label:"PAS - PASAPORTE"},{value:4,label:"OD - OTRO DOCUMENTO DE IDENTIDAD"}],loading:!1,ventaDialog:!1,efectivo:"",venta:{nit:"0",nombre:"SN",codigoTipoDocumentoIdentidad:1,tipo_venta:"Interno",tipo_pago:"Efectivo"},pagination:{page:1,rowsPerPage:24,rowsNumber:0},receta_id:null,recognition:null,activeField:null,productos:[],productosSearch:"",productosVentas:[],loteDialog:!1,lotesLoading:!1,lotes:[],loteSelected:null,loteCantidad:1,lotePrecio:0,loteProducto:null}},mounted(){if(this.$nextTick(()=>{this.$refs.inputBuscarProducto?.focus()}),this.productosGet(),"webkitSpeechRecognition"in window||"SpeechRecognition"in window){const l=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new l,this.recognition.lang="es-ES",this.recognition.interimResults=!1,this.recognition.continuous=!1,this.recognition.onresult=t=>{const v=t.results[0][0].transcript;this.activeField&&(this.venta[this.activeField]+=v)},this.recognition.onerror=t=>{console.error("Error en reconocimiento de voz:",t.error)}}},methods:{async openLoteDialog(l){this.loteProducto=l,this.loteDialog=!0,this.lotes=[],this.lotesLoading=!0;try{const t=await this.$axios.get(`productos/${l.id}/historial-compras-ventas`);this.lotes=t.data||[],this.lotes.length===1&&this.onPickLote(this.lotes[0])}catch(t){console.error(t),this.$alert?.error?.("No se pudieron cargar los lotes")||this.$q.notify({type:"negative",message:"No se pudieron cargar los lotes"}),this.loteDialog=!1}finally{this.lotesLoading=!1}},onPickLote(l){this.loteSelected=l,this.lotePrecio=Number(l?.precio_venta??this.loteProducto?.precio??0),this.loteCantidad=1},confirmarLote(){if(!this.loteSelected){this.$alert?.error?.("Selecciona un lote")||this.$q.notify({type:"negative",message:"Selecciona un lote"});return}const l=Number(this.loteSelected.disponible||0),t=Number(this.loteCantidad||0);if(t<=0||t>l){this.$alert?.error?.("Cantidad inválida para el lote")||this.$q.notify({type:"negative",message:"Cantidad inválida para el lote"});return}const v=Number(this.lotePrecio||0);this.productosVentas.push({producto_id:this.loteProducto.id,cantidad:t,precio:v,producto:this.loteProducto,compra_detalle_id:this.loteSelected.id,lote:this.loteSelected.lote,fecha_vencimiento:this.loteSelected.fecha_vencimiento}),this.loteDialog=!1,this.loteSelected=null,this.loteProducto=null,this.loteCantidad=1,this.lotePrecio=0},searchCliente(){this.loading=!0,this.$axios.post("searchCliente",{nit:this.venta.nit}).then(l=>{this.venta.nombre="SN",this.venta.email="",this.venta.codigoTipoDocumentoIdentidad=1,l.data.nombre&&(this.venta.nombre=l.data.nombre),l.data.email&&(this.venta.email=l.data.email),l.data.codigoTipoDocumentoIdentidad&&(this.venta.codigoTipoDocumentoIdentidad=parseInt(l.data.codigoTipoDocumentoIdentidad)),l.data.complemento&&(this.venta.complemento=l.data.complemento)}).catch(l=>console.error(l)).finally(()=>this.loading=!1)},clickDialogVenta(){if(this.productosVentas.length===0){this.$alert?.error?.("Debe agregar al menos un producto a la venta")||this.$q.notify({type:"negative",message:"Debe agregar al menos un producto a la venta"});return}this.ventaDialog=!0,this.efectivo=""},productosGet(){this.loading=!0,this.$axios.get("productosStock",{params:{search:this.productosSearch,page:this.pagination.page,per_page:this.pagination.rowsPerPage}}).then(l=>{this.productos=l.data.data,this.pagination.rowsNumber=l.data.total,this.pagination.page=l.data.current_page,this.productos.length===1&&this.productos[0].barra===this.productosSearch&&(this.openLoteDialog(this.productos[0]),this.productosSearch="")}).catch(l=>{console.error(l)}).finally(()=>{this.loading=!1})},submitVenta(){this.loading=!0,this.$axios.post("ventas",{ci:this.venta.nit,nombre:this.venta.nombre,email:this.venta.email,codigoTipoDocumentoIdentidad:this.venta.codigoTipoDocumentoIdentidad,complemento:this.venta.complemento,productos:this.productosVentas,tipo_venta:this.venta.tipo_venta,tipo_pago:this.venta.tipo_pago,receta_id:this.receta_id}).then(l=>{this.ventaDialog=!1,this.$alert?.success?.("Venta realizada con éxito"),this.productosVentas=[],this.venta={nit:"0",nombre:"SN",codigoTipoDocumentoIdentidad:1,tipo_venta:"Interno",tipo_pago:"Efectivo"},Q.printFactura(l.data),this.receta_id=null,this.$nextTick(()=>this.$refs.inputBuscarProducto?.focus()),this.productosGet()}).catch(l=>{console.error(l),this.$alert?.error?.(l?.response?.data?.message||"No se pudo realizar la venta")}).finally(()=>{this.loading=!1})},startRecognition(l){this.recognition?(this.activeField=l,this.recognition.start()):this.$q.notify({color:"negative",message:"El reconocimiento de voz no está soportado en este navegador"})}},computed:{totalVenta(){return this.productosVentas.reduce((l,t)=>l+Number(t.cantidad)*Number(t.precio),0)},cambio(){let l=Number(this.efectivo||0)-this.totalVenta;return l<0&&(l=0),l.toFixed(2)}}},B={class:"row"},R={class:"col-12 col-md-7 q-pa-xs"},F={class:"flex flex-center"},A={class:"row"},z={class:"absolute-bottom text-center",style:{padding:"0",margin:"0"}},O={style:{"max-width":"190px","line-height":"0.9"}},M={style:{display:"flex","justify-content":"space-between"}},G={class:"text-bold bg-orange text-black border"},X={class:"col-12 col-md-5 q-pa-xs"},j={class:"text-right flex items-center"},J={style:{padding:"0",margin:"0",display:"flex","align-items":"center"}},Z={style:{"max-width":"190px",overflow:"hidden","text-overflow":"ellipsis","line-height":".9"}},H={style:{padding:"0",margin:"0"}},K=["onUpdate:modelValue"],W={style:{padding:"0",margin:"0"}},Y=["onUpdate:modelValue"],$={class:"text-right"},ee={class:"text-right text-bold"},te={class:"row"},oe={class:"col-12 col-md-3 q-pa-xs"},le={class:"col-12 col-md-3 q-pa-xs"},ie={class:"col-12 col-md-3 q-pa-xs"},ne={class:"col-12 col-md-3 q-pa-xs"},se={class:"col-12 col-md-3 q-pa-xs"},ae={class:"col-12 col-md-6 q-pa-xs"},de={class:"col-12 q-pa-xs"},re={style:{padding:"0",margin:"0"}},ue={style:{"max-width":"190px",overflow:"hidden","text-overflow":"ellipsis","line-height":".9"}},ce={class:"text-right"},pe={class:"text-right text-bold"},me={class:"text-right"},he={class:"text-right"},ge={class:"col-12 q-pa-xs"},ve={class:"q-mb-sm text-subtitle2"},fe={key:0},be={class:"text-right"},xe={class:"text-right"},_e={key:1},Ve={key:0,class:"row q-col-gutter-sm q-mt-sm"},ye={class:"col-12 col-md-4"},De={class:"col-12 col-md-4"},we={class:"col-12 col-md-4 flex items-end"};function Ce(l,t,v,Se,i,d){return r(),T(q,{class:"q-pa-xs"},{default:a(()=>[n(f,{flat:"",bordered:""},{default:a(()=>[n(h,{class:"row items-center q-pb-none"},{default:a(()=>[t[17]||(t[17]=e("div",{class:"text-h6"},"Ventas",-1)),n(c,{flat:"",round:"",dense:"",icon:"arrow_back",onClick:t[0]||(t[0]=o=>l.$router.go(-1))}),n(c,{flat:"",round:"",dense:"",icon:"refresh",onClick:d.productosGet,loading:i.loading},null,8,["onClick","loading"]),n(_)]),_:1}),n(h,{class:"q-pa-none"},{default:a(()=>[n(k,{onSubmit:d.clickDialogVenta},{default:a(()=>[e("div",B,[e("div",R,[n(m,{ref:"inputBuscarProducto",modelValue:i.productosSearch,"onUpdate:modelValue":[t[1]||(t[1]=o=>i.productosSearch=o),d.productosGet],outlined:"",clearable:"",label:"Buscar producto",dense:"",debounce:"300"},{append:a(()=>[n(c,{flat:"",round:"",dense:"",icon:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"]),e("div",F,[n(U,{size:"xs",modelValue:i.pagination.page,"onUpdate:modelValue":[t[2]||(t[2]=o=>i.pagination.page=o),d.productosGet],max:Math.ceil(i.pagination.rowsNumber/i.pagination.rowsPerPage),color:"primary","boundary-numbers":"","max-pages":"5"},null,8,["modelValue","max","onUpdate:modelValue"])]),e("div",A,[(r(!0),u(b,null,x(i.productos,o=>(r(),u("div",{key:o.id,class:"col-6 col-md-2"},[n(f,{flat:"",bordered:"",class:"cursor-pointer",onClick:p=>d.openLoteDialog(o)},{default:a(()=>[n(N,{src:`${l.$url}/../${o.imagen}`,class:"q-mb-xs",style:{height:"120px"}},{default:a(()=>[e("div",z,[e("div",O,s(l.$filters.textUpper(o.nombre)),1),e("div",M,[e("span",null,s(o.stock),1),e("span",G,s(o.precio)+" Bs",1)])])]),_:2},1032,["src"])]),_:2},1032,["onClick"])]))),128))])]),e("div",X,[e("div",j,[n(_),n(c,{icon:"delete",size:"10px",color:"red",dense:"",flat:"","no-caps":"",label:"Limpiar",onClick:t[3]||(t[3]=o=>{i.productosVentas=[],i.receta_id=null})})]),n(w,{dense:"","wrap-cells":"",flat:"",bordered:""},{default:a(()=>[t[19]||(t[19]=e("thead",null,[e("tr",null,[e("th",null,"Producto"),e("th",null,"Lote"),e("th",null,"Vence"),e("th",null,"Cantidad"),e("th",null,"Precio"),e("th",null,"Subtotal")])],-1)),e("tbody",null,[(r(!0),u(b,null,x(i.productosVentas,(o,p)=>(r(),u("tr",{key:p},[e("td",J,[n(N,{src:`${l.$url}../images/${o.producto?.imagen}`,class:"q-mb-xs",style:{height:"35px",width:"35px"}},null,8,["src"]),e("div",Z,[n(E,{name:"delete",color:"red",class:"cursor-pointer",onClick:g=>i.productosVentas.splice(p,1)},null,8,["onClick"]),C(" "+s(l.$filters.textUpper(o.producto?.nombre)),1)])]),e("td",null,s(o.lote||"—"),1),e("td",null,s(o.fecha_vencimiento||"—"),1),e("td",H,[V(e("input",{"onUpdate:modelValue":g=>o.cantidad=g,type:"number",style:{width:"60px"},min:"1"},null,8,K),[[y,o.cantidad,void 0,{number:!0}]])]),e("td",W,[V(e("input",{"onUpdate:modelValue":g=>o.precio=g,type:"number",style:{width:"70px"},step:"0.01"},null,8,Y),[[y,o.precio,void 0,{number:!0}]])]),e("td",$,s((Number(o.cantidad)*Number(o.precio)).toFixed(2))+" Bs ",1)]))),128))]),e("tfoot",null,[e("tr",null,[t[18]||(t[18]=e("td",{colspan:"5",class:"text-right text-bold"},"Total",-1)),e("td",ee,s(d.totalVenta.toFixed(2))+" Bs ",1)])])]),_:1}),n(c,{label:"Realizar venta",color:"positive",class:"full-width","no-caps":"",loading:i.loading,type:"submit",icon:"add_circle_outline"},null,8,["loading"])])])]),_:1},8,["onSubmit"])]),_:1})]),_:1}),n(S,{modelValue:i.ventaDialog,"onUpdate:modelValue":t[12]||(t[12]=o=>i.ventaDialog=o)},{default:a(()=>[n(f,{style:{"max-width":"750px",width:"90vw"}},{default:a(()=>[n(h,{class:"q-pb-none row items-center"},{default:a(()=>[t[20]||(t[20]=e("div",{class:"text-h6"},"Nueva venta",-1)),n(_),n(c,{flat:"",round:"",dense:"",icon:"close",onClick:t[4]||(t[4]=o=>i.ventaDialog=!1)})]),_:1}),n(h,null,{default:a(()=>[n(k,{onSubmit:d.submitVenta},{default:a(()=>[e("div",te,[e("div",oe,[n(m,{modelValue:i.venta.nit,"onUpdate:modelValue":[t[5]||(t[5]=o=>i.venta.nit=o),d.searchCliente],outlined:"",dense:"",label:"CI/NIT",debounce:500},null,8,["modelValue","onUpdate:modelValue"])]),e("div",le,[n(m,{modelValue:i.venta.nombre,"onUpdate:modelValue":t[6]||(t[6]=o=>i.venta.nombre=o),outlined:"",dense:"",label:"Nombre"},null,8,["modelValue"])]),e("div",ie,[n(m,{modelValue:i.venta.email,"onUpdate:modelValue":t[7]||(t[7]=o=>i.venta.email=o),outlined:"",dense:"",label:"Email"},null,8,["modelValue"])]),e("div",ne,[n(m,{modelValue:i.venta.complemento,"onUpdate:modelValue":t[8]||(t[8]=o=>i.venta.complemento=o),outlined:"",dense:"",label:"Complemento"},null,8,["modelValue"])]),e("div",se,[n(I,{modelValue:i.venta.tipo_pago,"onUpdate:modelValue":t[9]||(t[9]=o=>i.venta.tipo_pago=o),outlined:"",dense:"",label:"Tipo de pago",options:["Efectivo","QR"]},null,8,["modelValue"])]),e("div",ae,[n(I,{modelValue:i.venta.codigoTipoDocumentoIdentidad,"onUpdate:modelValue":t[10]||(t[10]=o=>i.venta.codigoTipoDocumentoIdentidad=o),outlined:"",dense:"",label:"Tipo de documento",options:i.codigoTipoDocumentoIdentidades,"emit-value":"","map-options":""},null,8,["modelValue","options"])]),e("div",de,[n(w,{dense:"","wrap-cells":"",flat:"",bordered:""},{default:a(()=>[t[24]||(t[24]=e("thead",null,[e("tr",null,[e("th",null,"ID"),e("th",null,"Producto"),e("th",null,"Lote"),e("th",null,"Vence"),e("th",null,"Cant."),e("th",null,"Precio"),e("th",null,"Subtotal")])],-1)),e("tbody",null,[(r(!0),u(b,null,x(i.productosVentas,(o,p)=>(r(),u("tr",{key:"prev-"+p},[e("td",null,s(o.producto_id),1),e("td",re,[e("div",ue,s(l.$filters.textUpper(o.producto?.nombre||"")),1)]),e("td",null,s(o.lote||"—"),1),e("td",null,s(o.fecha_vencimiento||"—"),1),e("td",null,s(o.cantidad),1),e("td",null,s(Number(o.precio).toFixed(2))+" Bs",1),e("td",ce,s((Number(o.cantidad)*Number(o.precio)).toFixed(2))+" Bs ",1)]))),128))]),e("tfoot",null,[e("tr",null,[t[21]||(t[21]=e("td",{colspan:"6",class:"text-right text-bold"},"Total",-1)),e("td",pe,s(d.totalVenta.toFixed(2))+" Bs",1)]),e("tr",null,[t[22]||(t[22]=e("td",{colspan:"6",class:"text-right text-bold"},"Efectivo",-1)),e("td",me,[V(e("input",{"onUpdate:modelValue":t[11]||(t[11]=o=>i.efectivo=o),type:"number",step:"0.01",style:{width:"100px"}},null,512),[[y,i.efectivo,void 0,{number:!0}]])])]),e("tr",null,[t[23]||(t[23]=e("td",{colspan:"6",class:"text-right text-bold"},"Cambio",-1)),e("td",he,s(d.cambio),1)])])]),_:1})]),e("div",ge,[n(c,{label:"Realizar venta",color:"positive",class:"full-width","no-caps":"",loading:i.loading,type:"submit"},null,8,["loading"])])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(S,{modelValue:i.loteDialog,"onUpdate:modelValue":t[16]||(t[16]=o=>i.loteDialog=o),persistent:""},{default:a(()=>[n(f,{style:{"max-width":"700px",width:"90vw"}},{default:a(()=>[n(h,{class:"row items-center q-pb-none"},{default:a(()=>[t[25]||(t[25]=e("div",{class:"text-h6"},"Seleccionar lote",-1)),n(_),n(c,{flat:"",round:"",dense:"",icon:"close",onClick:t[13]||(t[13]=o=>i.loteDialog=!1)})]),_:1}),n(h,null,{default:a(()=>[e("div",ve,[t[26]||(t[26]=C(" Producto: ")),e("b",null,s(l.$filters.textUpper(i.loteProducto?.nombre||"")),1)]),n(w,{dense:"",flat:"",bordered:"","wrap-cells":""},{default:a(()=>[t[29]||(t[29]=e("thead",null,[e("tr",null,[e("th",null,"#"),e("th",null,"Lote"),e("th",null,"Vencimiento"),e("th",null,"Disponible"),e("th",null,"Precio venta"),e("th")])],-1)),e("tbody",null,[i.lotesLoading?(r(),u("tr",fe,t[27]||(t[27]=[e("td",{colspan:"6",class:"text-center"},"Cargando…",-1)]))):D("",!0),(r(!0),u(b,null,x(i.lotes,(o,p)=>(r(),u("tr",{key:o.id},[e("td",null,s(p+1),1),e("td",null,s(o.lote||"—"),1),e("td",null,s(o.fecha_vencimiento||"—"),1),e("td",be,s(o.disponible),1),e("td",xe,s(Number(o.precio_venta||0).toFixed(2))+" Bs",1),e("td",null,[n(c,{size:"xs",color:"primary",flat:"","no-caps":"",label:"Elegir",onClick:g=>d.onPickLote(o)},null,8,["onClick"])])]))),128)),!i.lotesLoading&&i.lotes.length===0?(r(),u("tr",_e,t[28]||(t[28]=[e("td",{colspan:"6",class:"text-center text-negative"},"Sin lotes disponibles",-1)]))):D("",!0)])]),_:1}),i.loteSelected?(r(),u("div",Ve,[e("div",ye,[n(m,{modelValue:i.loteCantidad,"onUpdate:modelValue":t[14]||(t[14]=o=>i.loteCantidad=o),modelModifiers:{number:!0},type:"number",dense:"",outlined:"",label:"Cantidad a vender",min:1,max:Number(i.loteSelected.disponible||0)},null,8,["modelValue","max"])]),e("div",De,[n(m,{modelValue:i.lotePrecio,"onUpdate:modelValue":t[15]||(t[15]=o=>i.lotePrecio=o),modelModifiers:{number:!0},type:"number",step:"0.01",dense:"",outlined:"",label:"Precio (editable)"},null,8,["modelValue"])]),e("div",we,[n(c,{color:"primary",icon:"add_shopping_cart",label:"Agregar a venta","no-caps":"",onClick:d.confirmarLote},null,8,["onClick"])])])):D("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),t[30]||(t[30]=e("div",{id:"myElement",class:"hidden"},null,-1))]),_:1})}const Oe=P(L,[["render",Ce]]);export{Oe as default};
