import{g as la,r as u,p as ta,l as na,c as h,o as c,w as t,b as l,a as o,Q as I,e as $,aa as E,d as N,f as _,a2 as p,t as s,Z as y,h as H,a6 as sa,a3 as k,a4 as F,a5 as G,a1 as A,ac as ra}from"./index-CmoW1HI-.js";import{Q as Z}from"./QSelect-YWvpHr97.js";import{Q as f}from"./QChip-B_XB_8XG.js";import{Q as da,a as B}from"./QTable-CP-Eucbl.js";import{a as U,b as w}from"./QMenu-j9-YnpjT.js";import{Q as J}from"./QList-MksEbVq0.js";import{Q as K,C}from"./ClosePopup-veQafRnd.js";import{Q as ia}from"./QImg-BFhzNBj4.js";import{Q as ua}from"./QMarkupTable-6CKuV8-r.js";import{Q as ca}from"./QSpace-CghvMLQs.js";import{Q as pa}from"./QFile-Tkc9OR7X.js";import{Q as ma}from"./QPage-Dl-a7fNa.js";import"./QItemLabel-BiiYZsTs.js";import"./format-CJebrXOQ.js";const ga={class:"col-12 col-md-7"},va={class:"col-6 col-md-2"},_a={class:"col-6 col-md-3"},fa={class:"col-6 col-md-3"},ba={class:"col-6 col-md-3"},ha={class:"col-6 col-md-3"},wa={class:"col-6 col-md-3"},ya={class:"row full-width items-center justify-end q-gutter-sm q-pa-sm"},Ca={class:"text-caption"},xa={class:"col"},Va={class:"text-subtitle1 text-weight-bold"},$a={class:"text-caption text-grey-7"},ka={colspan:"8",class:"bg-grey-1"},Qa={key:0,class:"text-caption text-grey-7"},Ta={class:"col-auto"},Na={class:"col-auto"},Aa={class:"col-auto"},za={class:"col-auto"},Sa={class:"col-auto"},Pa={class:"col-auto"},Ia={key:0,class:"text-negative"},Ea={class:"col-auto"},Ua={class:"col-auto"},qa={class:"text-h6"},Da={class:"text-caption text-grey-8 q-mb-sm"},Oa={class:"row q-col-gutter-sm"},Fa={class:"col-12 col-md-4"},Ba={class:"col-12 col-md-4"},Ma={class:"col-12 col-md-4"},Ra={class:"col-12"},La={class:"col-12"},re={__name:"HistorialCobranzas",setup(ja){const{proxy:d}=la(),x=u(!1),q=u(!1),D=u(""),Q=u(50),M=u([]),z=u({}),m=u({page:1,per_page:50,total:0,last_page:1}),O=u(!1),g=u(null),R=u([]),S=u(!1),T=u(null),V=u(null),W=["EFECTIVO","QR","TRANSFERENCIA","OTRO"],i=u({monto:null,metodo_pago:"EFECTIVO",nro_pago:"",observacion:"",comprobante:null}),X=[{name:"actions",label:"Acciones",align:"left"},{name:"cliente_nombre",label:"Cliente",field:"cliente_nombre",align:"left"},{name:"ci_nit",label:"CI/NIT",field:"ci_nit",align:"left"},{name:"telefono",label:"Telefono",field:"telefono",align:"left"},{name:"documentos",label:"Documentos",field:"documentos",align:"right"},{name:"pagos_total",label:"Pagos",field:"pagos_total",align:"right"},{name:"monto_total",label:"Total",field:n=>v(n.monto_total),align:"right"},{name:"cobrado_total",label:"Cobrado",field:n=>v(n.cobrado_total),align:"right"},{name:"saldo_total",label:"Saldo",field:"saldo_total",align:"right"},{name:"estado",label:"Estado",field:"estado",align:"left"}];function v(n){return Number(n||0).toFixed(2)}function Y(n){return n?/\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(String(n)):!1}async function b(n=1){x.value=!0;try{const a=await d.$axios.get("/cobranzas/historial-clientes",{params:{search:D.value||void 0,per_page:Q.value,page:n}});M.value=Array.isArray(a.data?.data)?a.data.data:[],z.value=a.data?.stats||{},m.value=a.data?.pagination||{page:1,per_page:Q.value,total:0,last_page:1}}catch(a){d.$alert.error(a?.response?.data?.message||"No se pudo cargar historial")}finally{x.value=!1}}async function P(n){try{const a=await d.$axios.get(`/cobranzas/historial-clientes/${n.cliente_id}`);g.value=a.data?.cliente||null,R.value=Array.isArray(a.data?.items)?a.data.items:[],O.value=!0}catch(a){d.$alert.error(a?.response?.data?.message||"No se pudo cargar detalle del cliente")}}function L(n){const e=(Array.isArray(n?.pagos)?n.pagos:[]).filter(r=>String(r?.estado||"ACTIVO").toUpperCase()!=="ANULADO");return e.length?e[e.length-1]:null}function j(n,a){T.value=n,V.value=a,i.value={monto:Number(a?a.monto||0:n.saldo||0),metodo_pago:a?.metodo_pago||"EFECTIVO",nro_pago:a?.nro_pago||"",observacion:a?.observacion||"",comprobante:null},S.value=!0}async function aa(n,a){try{n.tipo==="VENTA"?await d.$axios.put(`/cobranzas/ventas/${n.id}/considerar`,{considerar_en_cobranza:a}):await d.$axios.put(`/cobranzas/deudas-manuales/${n.id}/considerar`,{considerar_en_cobranza:a}),d.$alert.success("Documento actualizado"),g.value?.id&&await P({cliente_id:g.value.id}),await b(m.value.page||1)}catch(e){d.$alert.error(e?.response?.data?.message||"No se pudo actualizar documento")}}async function ea(){if(T.value){q.value=!0;try{const n=new FormData;n.append("monto",String(Number(i.value.monto||0))),n.append("metodo_pago",String(i.value.metodo_pago||"EFECTIVO")),n.append("nro_pago",String(i.value.nro_pago||"")),n.append("observacion",String(i.value.observacion||"")),i.value.comprobante&&n.append("comprobante",i.value.comprobante);const a=T.value;a.tipo==="VENTA"?V.value?.id?(n.append("_method","PUT"),await d.$axios.post(`/cobranzas/pagos/ventas/${V.value.id}`,n,{headers:{"Content-Type":"multipart/form-data"}})):(n.append("venta_id",String(a.id)),await d.$axios.post("/cobranzas/pagos/ventas",n,{headers:{"Content-Type":"multipart/form-data"}})):V.value?.id?(n.append("_method","PUT"),await d.$axios.post(`/cobranzas/deudas-manuales/pagos/${V.value.id}`,n,{headers:{"Content-Type":"multipart/form-data"}})):await d.$axios.post(`/cobranzas/deudas-manuales/${a.id}/pagos`,n,{headers:{"Content-Type":"multipart/form-data"}}),d.$alert.success("Pago guardado"),S.value=!1,g.value?.id&&await P({cliente_id:g.value.id}),await b(m.value.page||1)}catch(n){d.$alert.error(n?.response?.data?.message||"No se pudo guardar pago")}finally{q.value=!1}}}async function oa(n,a){if(await new Promise(r=>{d.$q.dialog({title:"Anular pago",message:`Se anulara el pago #${a?.id}. Desea continuar?`,cancel:!0,persistent:!0}).onOk(()=>r(!0)).onCancel(()=>r(!1))}))try{n.tipo==="VENTA"?await d.$axios.put(`/cobranzas/pagos/ventas/${a.id}/anular`,{}):await d.$axios.put(`/cobranzas/deudas-manuales/pagos/${a.id}/anular`,{}),d.$alert.success("Pago anulado"),g.value?.id&&await P({cliente_id:g.value.id}),await b(m.value.page||1)}catch(r){d.$alert.error(r?.response?.data?.message||"No se pudo anular pago")}}return ta(Q,()=>b(1)),na(()=>b(1)),(n,a)=>(c(),h(ma,{class:"q-pa-sm"},{default:t(()=>[a[17]||(a[17]=l("div",{class:"text-h6 text-weight-bold q-mb-sm"},"Historial de cobranzas",-1)),o(I,{flat:"",bordered:"",class:"q-mb-sm"},{default:t(()=>[o($,{class:"row q-col-gutter-sm items-center"},{default:t(()=>[l("div",ga,[o(E,{modelValue:D.value,"onUpdate:modelValue":a[0]||(a[0]=e=>D.value=e),dense:"",outlined:"",label:"Buscar cliente/CI/tel/direccion",debounce:"300"},{append:t(()=>[o(N,{name:"search"})]),_:1},8,["modelValue"])]),l("div",va,[o(Z,{modelValue:Q.value,"onUpdate:modelValue":a[1]||(a[1]=e=>Q.value=e),options:[20,50,100,150,200],dense:"",outlined:"",label:"Filas"},null,8,["modelValue"])]),l("div",_a,[o(_,{color:"primary","no-caps":"",icon:"search",label:"Consultar",class:"full-width",loading:x.value,onClick:a[2]||(a[2]=e=>b(1))},null,8,["loading"])])]),_:1}),o($,{class:"row q-col-gutter-sm q-pt-none"},{default:t(()=>[l("div",fa,[o(f,{color:"blue-8","text-color":"white"},{default:t(()=>[p("Clientes: "+s(m.value.total||0),1)]),_:1})]),l("div",ba,[o(f,{color:"indigo-8","text-color":"white"},{default:t(()=>[p("Docs pagina: "+s(z.value.documentos||0),1)]),_:1})]),l("div",ha,[o(f,{color:"green-8","text-color":"white"},{default:t(()=>[p("Pagos pagina: "+s(z.value.pagos||0),1)]),_:1})]),l("div",wa,[o(f,{color:"negative","text-color":"white"},{default:t(()=>[p("Saldo pagina: "+s(v(z.value.saldo_total)),1)]),_:1})])]),_:1})]),_:1}),o(I,{flat:"",bordered:""},{default:t(()=>[o(da,{dense:"",flat:"","row-key":"cliente_id",rows:M.value,columns:X,loading:x.value,pagination:{rowsPerPage:0}},{"body-cell-estado":t(e=>[o(B,{props:e},{default:t(()=>[o(f,{dense:"",color:e.row.estado==="DEBE"?"negative":"positive","text-color":"white"},{default:t(()=>[p(s(e.row.estado),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-saldo_total":t(e=>[o(B,{props:e},{default:t(()=>[o(f,{dense:"",color:Number(e.row.saldo_total||0)>0?"negative":"positive","text-color":"white"},{default:t(()=>[p(s(v(e.row.saldo_total)),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-actions":t(e=>[o(B,{props:e},{default:t(()=>[o(K,{dense:"",color:"primary","no-caps":"",label:"Opciones"},{default:t(()=>[o(J,null,{default:t(()=>[y((c(),h(U,{clickable:"",onClick:r=>P(e.row)},{default:t(()=>[o(w,{avatar:""},{default:t(()=>[o(N,{name:"visibility"})]),_:1}),o(w,null,{default:t(()=>a[12]||(a[12]=[p("Ver historial")])),_:1})]),_:2},1032,["onClick"])),[[C]])]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),bottom:t(()=>[l("div",ya,[o(_,{flat:"",dense:"",icon:"chevron_left",disable:m.value.page<=1||x.value,onClick:a[3]||(a[3]=e=>b(m.value.page-1))},null,8,["disable"]),l("div",Ca,"Pagina "+s(m.value.page)+" / "+s(m.value.last_page),1),o(_,{flat:"",dense:"",icon:"chevron_right",disable:m.value.page>=m.value.last_page||x.value,onClick:a[4]||(a[4]=e=>b(m.value.page+1))},null,8,["disable"])])]),_:1},8,["rows","loading"])]),_:1}),o(H,{modelValue:O.value,"onUpdate:modelValue":a[5]||(a[5]=e=>O.value=e),"full-width":""},{default:t(()=>[o(I,{style:{"max-width":"1200px",margin:"0 auto"}},{default:t(()=>[o($,{class:"row items-center"},{default:t(()=>[l("div",xa,[l("div",Va,s(g.value?.nombre||"-"),1),l("div",$a,s(g.value?.ci||"-")+" - "+s(g.value?.telefono||"-"),1)]),y(o(_,{flat:"",icon:"close",round:"",dense:""},null,512),[[C]])]),_:1}),o(sa),o($,null,{default:t(()=>[o(ua,{dense:"",flat:"",bordered:"","wrap-cells":""},{default:t(()=>[a[16]||(a[16]=l("thead",null,[l("tr",null,[l("th",null,"Tipo"),l("th",null,"Referencia"),l("th",null,"Fecha"),l("th",null,"Total"),l("th",null,"Cobrado"),l("th",null,"Saldo"),l("th",null,"Estado"),l("th",null,"Acciones")])],-1)),l("tbody",null,[(c(!0),k(F,null,G(R.value,e=>(c(),k(F,{key:`${e.tipo}-${e.id}`},[l("tr",null,[l("td",null,s(e.tipo),1),l("td",null,s(e.referencia),1),l("td",null,s(e.fecha||"-"),1),l("td",null,s(v(e.monto_total)),1),l("td",null,s(v(e.cobrado)),1),l("td",null,[o(f,{dense:"",color:Number(e.saldo||0)>0?"negative":"positive","text-color":"white"},{default:t(()=>[p(s(v(e.saldo)),1)]),_:2},1032,["color"])]),l("td",null,[o(f,{dense:"",color:e.considerar_en_cobranza?"blue-7":"grey-7","text-color":"white"},{default:t(()=>[p(s(e.considerar_en_cobranza?"En cobranza":"No considerar"),1)]),_:2},1032,["color"])]),l("td",null,[o(K,{dense:"",color:"primary","no-caps":"",label:"Opciones"},{default:t(()=>[o(J,null,{default:t(()=>[y((c(),h(U,{clickable:"",onClick:r=>j(e,null),disable:Number(e.saldo||0)<=0||!e.considerar_en_cobranza},{default:t(()=>[o(w,{avatar:""},{default:t(()=>[o(N,{name:"payments"})]),_:1}),o(w,null,{default:t(()=>a[13]||(a[13]=[p("Pagar")])),_:1})]),_:2},1032,["onClick","disable"])),[[C]]),y((c(),h(U,{clickable:"",onClick:r=>j(e,L(e)),disable:!L(e)||!e.considerar_en_cobranza},{default:t(()=>[o(w,{avatar:""},{default:t(()=>[o(N,{name:"edit"})]),_:1}),o(w,null,{default:t(()=>a[14]||(a[14]=[p("Modificar ultimo pago")])),_:1})]),_:2},1032,["onClick","disable"])),[[C]]),y((c(),h(U,{clickable:"",onClick:r=>aa(e,!e.considerar_en_cobranza)},{default:t(()=>[o(w,{avatar:""},{default:t(()=>[o(N,{name:"rule"})]),_:1}),o(w,null,{default:t(()=>[p(s(e.considerar_en_cobranza?"No considerar en cobranza":"Volver a considerar"),1)]),_:2},1024)]),_:2},1032,["onClick"])),[[C]])]),_:2},1024)]),_:2},1024)])]),l("tr",null,[l("td",ka,[a[15]||(a[15]=l("div",{class:"text-caption text-grey-7 text-weight-bold q-mb-xs"},"Pagos:",-1)),(e.pagos||[]).length?A("",!0):(c(),k("div",Qa,"Sin pagos")),(c(!0),k(F,null,G(e.pagos||[],r=>(c(),k("div",{key:`pg-${e.tipo}-${e.id}-${r.id}`,class:"row items-center no-wrap q-col-gutter-sm q-py-xs"},[l("div",Ta,"#"+s(r.id)+" - "+s(v(r.monto)),1),l("div",Na,[o(f,{dense:"",color:String(r.estado||"ACTIVO").toUpperCase()==="ANULADO"?"negative":"positive","text-color":"white"},{default:t(()=>[p(s(String(r.estado||"ACTIVO").toUpperCase()),1)]),_:2},1032,["color"])]),l("div",Aa,s(r.metodo_pago),1),l("div",za,s(r.nro_pago||"-"),1),l("div",Sa,s(r.fecha_hora||"-"),1),l("div",Pa,[p(s(r.registrado_por||"Sin usuario")+" ",1),r.anulado_por?(c(),k("div",Ia,"Anulado: "+s(r.anulado_por),1)):A("",!0)]),l("div",Ea,[r.comprobante_url?(c(),h(_,{key:0,dense:"",flat:"",color:"primary",icon:"attach_file",label:"Ver comp.","no-caps":"",href:r.comprobante_url,target:"_blank"},null,8,["href"])):A("",!0),Y(r.comprobante_url)?(c(),h(ia,{key:1,src:r.comprobante_url,style:{width:"28px",height:"28px","border-radius":"4px"},fit:"cover",class:"q-ml-xs"},null,8,["src"])):A("",!0)]),l("div",Ua,[String(r.estado||"ACTIVO").toUpperCase()!=="ANULADO"?(c(),h(_,{key:0,dense:"",flat:"",color:"negative",icon:"cancel",label:"Anular","no-caps":"",onClick:Ha=>oa(e,r)},null,8,["onClick"])):A("",!0)])]))),128))])])],64))),128))])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(H,{modelValue:S.value,"onUpdate:modelValue":a[11]||(a[11]=e=>S.value=e)},{default:t(()=>[o(I,{style:{width:"560px","max-width":"96vw"}},{default:t(()=>[o($,{class:"row items-center q-pb-none"},{default:t(()=>[l("div",qa,s(V.value?"Modificar pago":"Registrar pago"),1),o(ca),y(o(_,{flat:"",dense:"",round:"",icon:"close"},null,512),[[C]])]),_:1}),o($,null,{default:t(()=>[l("div",Da,s(T.value?.referencia||"-")+" - Saldo: "+s(v(T.value?.saldo||0)),1),l("div",Oa,[l("div",Fa,[o(E,{modelValue:i.value.monto,"onUpdate:modelValue":a[6]||(a[6]=e=>i.value.monto=e),modelModifiers:{number:!0},type:"number",min:"0.01",step:"0.01",dense:"",outlined:"",label:"Monto"},null,8,["modelValue"])]),l("div",Ba,[o(Z,{modelValue:i.value.metodo_pago,"onUpdate:modelValue":a[7]||(a[7]=e=>i.value.metodo_pago=e),options:W,dense:"",outlined:"",label:"Metodo"},null,8,["modelValue"])]),l("div",Ma,[o(E,{modelValue:i.value.nro_pago,"onUpdate:modelValue":a[8]||(a[8]=e=>i.value.nro_pago=e),dense:"",outlined:"",label:"Nro pago"},null,8,["modelValue"])]),l("div",Ra,[o(E,{modelValue:i.value.observacion,"onUpdate:modelValue":a[9]||(a[9]=e=>i.value.observacion=e),dense:"",outlined:"",label:"Comentario"},null,8,["modelValue"])]),l("div",La,[o(pa,{modelValue:i.value.comprobante,"onUpdate:modelValue":a[10]||(a[10]=e=>i.value.comprobante=e),dense:"",outlined:"",label:"Foto/PDF comprobante",accept:".jpg,.jpeg,.png,.pdf"},null,8,["modelValue"])])])]),_:1}),o(ra,{align:"right"},{default:t(()=>[y(o(_,{flat:"",color:"grey-8","no-caps":"",label:"Cancelar"},null,512),[[C]]),o(_,{color:"primary","no-caps":"",label:"Guardar",loading:q.value,onClick:ea},null,8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}};export{re as default};
