import{g as me,r as c,l as pe,c as h,o as m,w as t,b as l,a,Q as z,e as w,aa as f,d as $,f as b,a2 as v,t as d,Z as g,h as R,a6 as ve,a3 as N,a4 as L,a5 as H,a1 as A,ac as J}from"./index-CmoW1HI-.js";import{Q as C}from"./QChip-B_XB_8XG.js";import{Q as fe,a as K}from"./QTable-CP-Eucbl.js";import{a as S,b as y}from"./QMenu-j9-YnpjT.js";import{Q as W}from"./QList-MksEbVq0.js";import{Q as X,C as V}from"./ClosePopup-veQafRnd.js";import{Q as _e}from"./QImg-BFhzNBj4.js";import{Q as be}from"./QMarkupTable-6CKuV8-r.js";import{Q as Y}from"./QSpace-CghvMLQs.js";import{Q as ee}from"./QSelect-YWvpHr97.js";import{Q as ge}from"./QFile-Tkc9OR7X.js";import{Q as ye}from"./QPage-Dl-a7fNa.js";import"./QItemLabel-BiiYZsTs.js";import"./format-CJebrXOQ.js";const Ve={class:"col-12 col-md-8"},he={class:"col-6 col-md-2"},we={class:"col-6 col-md-2"},Ce={class:"col-6 col-md-3"},xe={class:"col-6 col-md-3"},ke={class:"col-6 col-md-3"},$e={class:"col-6 col-md-3"},Ne={class:"col"},Qe={class:"text-subtitle1 text-weight-bold"},Te={class:"text-caption text-grey-7"},Ue={colspan:"8",class:"bg-grey-1"},ze={key:0,class:"text-caption text-grey-7"},Ae={class:"col-auto"},Se={class:"col-auto"},De={class:"col-auto"},Ie={class:"col-auto"},Pe={class:"col-auto"},Oe={class:"col-auto"},Ee={key:0,class:"text-negative"},qe={class:"col-auto"},Fe={class:"col-auto"},Me={class:"text-h6"},Be={class:"text-caption text-grey-8 q-mb-sm"},Re={class:"row q-col-gutter-sm"},Le={class:"col-12 col-md-4"},je={class:"col-12 col-md-4"},Ge={class:"col-12 col-md-4"},Ze={class:"col-12"},He={class:"col-12"},Je={class:"row q-col-gutter-sm"},Ke={class:"col-12"},We={class:"col-12 col-md-6"},Xe={class:"col-12 col-md-6"},Ye={class:"col-12 col-md-6"},ea={class:"col-12 col-md-6"},aa={class:"col-12 col-md-4"},oa={class:"col-12 col-md-4"},la={class:"col-12 col-md-4"},ta={class:"col-12"},Va={__name:"Cobranzas",setup(na){const{proxy:r}=me(),j=new Date().toISOString().slice(0,10),P=c(""),O=c(!1),E=c(!1),q=c(!1),Q=c([]),T=c({}),F=c(!1),D=c(!1),I=c(!1),p=c(null),U=c(null),x=c(null),ae=["EFECTIVO","QR","TRANSFERENCIA","OTRO"],M=c([]),oe=[{name:"actions",label:"Acciones",align:"left"},{name:"cliente_nombre",label:"Cliente",field:"cliente_nombre",align:"left"},{name:"ci_nit",label:"CI/NIT",field:"ci_nit",align:"left"},{name:"telefono",label:"Telefono",field:"telefono",align:"left"},{name:"documentos",label:"Documentos",field:"documentos",align:"right"},{name:"monto_total",label:"Monto total",field:n=>_(n.monto_total),align:"right"},{name:"cobrado_total",label:"Cobrado",field:n=>_(n.cobrado_total),align:"right"},{name:"saldo_total",label:"Saldo",field:"saldo_total",align:"right"}],i=c({monto:null,metodo_pago:"EFECTIVO",nro_pago:"",observacion:"",comprobante:null}),u=c({cliente_id:null,nombre_cliente:"",ci_nit:"",telefono:"",direccion:"",monto_total:null,tolerancia_centavos:.99,fecha:j,observacion:""});function _(n){return Number(n||0).toFixed(2)}function le(n){return n?/\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(String(n)):!1}async function k(){O.value=!0;try{const n=await r.$axios.get("/cobranzas/deudores",{params:{search:P.value||void 0}});Q.value=Array.isArray(n.data?.data)?n.data.data:[],T.value=n.data?.stats||{}}catch(n){r.$alert.error(n?.response?.data?.message||"No se pudo cargar deudores")}finally{O.value=!1}}function te(n){p.value=n,F.value=!0}function G(n){const e=(Array.isArray(n?.pagos)?n.pagos:[]).filter(s=>String(s?.estado||"ACTIVO").toUpperCase()!=="ANULADO");return e.length?e[e.length-1]:null}function ne(n){const o=(n?.items||[]).filter(e=>Number(e?.saldo||0)>0&&!!e.considerar_en_cobranza);if(!o.length){r.$alert.error("No hay documentos con saldo pendiente");return}B(o[0],null)}function B(n,o){U.value=n,x.value=o,i.value={monto:Number(o?o.monto||0:n.saldo||0),metodo_pago:o?.metodo_pago||"EFECTIVO",nro_pago:o?.nro_pago||"",observacion:o?.observacion||"",comprobante:null},D.value=!0}async function se(n,o){try{if(n.tipo==="VENTA"?await r.$axios.put(`/cobranzas/ventas/${n.id}/considerar`,{considerar_en_cobranza:o}):await r.$axios.put(`/cobranzas/deudas-manuales/${n.id}/considerar`,{considerar_en_cobranza:o}),r.$alert.success("Documento actualizado"),await k(),p.value){const e=Q.value.find(s=>s.key===p.value.key);e&&(p.value=e)}}catch(e){r.$alert.error(e?.response?.data?.message||"No se pudo actualizar documento")}}async function de(){if(U.value){E.value=!0;try{const n=new FormData;n.append("monto",String(Number(i.value.monto||0))),n.append("metodo_pago",String(i.value.metodo_pago||"EFECTIVO")),n.append("nro_pago",String(i.value.nro_pago||"")),n.append("observacion",String(i.value.observacion||"")),i.value.comprobante&&n.append("comprobante",i.value.comprobante);const o=U.value;if(o.tipo==="VENTA"?x.value?.id?(n.append("_method","PUT"),await r.$axios.post(`/cobranzas/pagos/ventas/${x.value.id}`,n,{headers:{"Content-Type":"multipart/form-data"}})):(n.append("venta_id",String(o.id)),await r.$axios.post("/cobranzas/pagos/ventas",n,{headers:{"Content-Type":"multipart/form-data"}})):x.value?.id?(n.append("_method","PUT"),await r.$axios.post(`/cobranzas/deudas-manuales/pagos/${x.value.id}`,n,{headers:{"Content-Type":"multipart/form-data"}})):await r.$axios.post(`/cobranzas/deudas-manuales/${o.id}/pagos`,n,{headers:{"Content-Type":"multipart/form-data"}}),r.$alert.success("Pago guardado"),D.value=!1,await k(),p.value){const e=Q.value.find(s=>s.key===p.value.key);e&&(p.value=e)}}catch(n){r.$alert.error(n?.response?.data?.message||"No se pudo guardar pago")}finally{E.value=!1}}}async function re(n,o){if(await new Promise(s=>{r.$q.dialog({title:"Anular pago",message:`Se anulara el pago #${o?.id}. Desea continuar?`,cancel:!0,persistent:!0}).onOk(()=>s(!0)).onCancel(()=>s(!1))}))try{if(n.tipo==="VENTA"?await r.$axios.put(`/cobranzas/pagos/ventas/${o.id}/anular`,{}):await r.$axios.put(`/cobranzas/deudas-manuales/pagos/${o.id}/anular`,{}),r.$alert.success("Pago anulado"),await k(),p.value){const s=Q.value.find(Z=>Z.key===p.value.key);s&&(p.value=s)}}catch(s){r.$alert.error(s?.response?.data?.message||"No se pudo anular pago")}}function ue(){u.value={cliente_id:null,nombre_cliente:"",ci_nit:"",telefono:"",direccion:"",monto_total:null,tolerancia_centavos:.99,fecha:j,observacion:""},I.value=!0}async function ie(n,o){o(async()=>{try{const e=await r.$axios.get("/cobranzas/clientes",{params:{search:n||void 0}});M.value=(e.data||[]).map(s=>({label:`${s.nombre} (${s.ci||"-"})`,value:s.id,meta:s}))}catch{M.value=[]}})}async function ce(){q.value=!0;try{await r.$axios.post("/cobranzas/deudas-manuales",{...u.value,monto_total:Number(u.value.monto_total||0),tolerancia_centavos:Number(u.value.tolerancia_centavos||.99)}),r.$alert.success("Deuda manual creada"),I.value=!1,await k()}catch(n){r.$alert.error(n?.response?.data?.message||"No se pudo crear deuda manual")}finally{q.value=!1}}return pe(k),(n,o)=>(m(),h(ye,{class:"q-pa-sm"},{default:t(()=>[o[25]||(o[25]=l("div",{class:"text-h6 text-weight-bold q-mb-sm"},"Cobranzas de deudas",-1)),a(z,{flat:"",bordered:"",class:"q-mb-sm"},{default:t(()=>[a(w,{class:"row q-col-gutter-sm items-center"},{default:t(()=>[l("div",Ve,[a(f,{modelValue:P.value,"onUpdate:modelValue":o[0]||(o[0]=e=>P.value=e),dense:"",outlined:"",label:"Buscar cliente/CI/tel",debounce:"300"},{append:t(()=>[a($,{name:"search"})]),_:1},8,["modelValue"])]),l("div",he,[a(b,{color:"primary","no-caps":"",icon:"search",label:"Consultar",class:"full-width",loading:O.value,onClick:k},null,8,["loading"])]),l("div",we,[a(b,{color:"positive","no-caps":"",icon:"add",label:"Deuda manual",class:"full-width",onClick:ue})])]),_:1}),a(w,{class:"row q-col-gutter-sm q-pt-none"},{default:t(()=>[l("div",Ce,[a(C,{color:"blue-8","text-color":"white"},{default:t(()=>[v("Deudores: "+d(T.value.deudores||0),1)]),_:1})]),l("div",xe,[a(C,{color:"indigo-8","text-color":"white"},{default:t(()=>[v("Total Bs: "+d(_(T.value.monto_total)),1)]),_:1})]),l("div",ke,[a(C,{color:"green-8","text-color":"white"},{default:t(()=>[v("Cobrado Bs: "+d(_(T.value.cobrado_total)),1)]),_:1})]),l("div",$e,[a(C,{color:"negative","text-color":"white"},{default:t(()=>[v("Saldo Bs: "+d(_(T.value.saldo_total)),1)]),_:1})])]),_:1})]),_:1}),a(z,{flat:"",bordered:""},{default:t(()=>[a(fe,{dense:"",flat:"","row-key":"key",rows:Q.value,columns:oe,pagination:{rowsPerPage:0}},{"body-cell-saldo_total":t(e=>[a(K,{props:e},{default:t(()=>[a(C,{dense:"",color:"negative","text-color":"white"},{default:t(()=>[v(d(_(e.row.saldo_total)),1)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-actions":t(e=>[a(K,{props:e},{default:t(()=>[a(X,{dense:"",color:"primary","no-caps":"",label:"Opciones"},{default:t(()=>[a(W,null,{default:t(()=>[g((m(),h(S,{clickable:"",onClick:s=>te(e.row)},{default:t(()=>[a(y,{avatar:""},{default:t(()=>[a($,{name:"visibility"})]),_:1}),a(y,null,{default:t(()=>o[18]||(o[18]=[v("Ver detalle")])),_:1})]),_:2},1032,["onClick"])),[[V]]),g((m(),h(S,{clickable:"",onClick:s=>ne(e.row)},{default:t(()=>[a(y,{avatar:""},{default:t(()=>[a($,{name:"payments"})]),_:1}),a(y,null,{default:t(()=>o[19]||(o[19]=[v("Registrar pago")])),_:1})]),_:2},1032,["onClick"])),[[V]])]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),_:1},8,["rows"])]),_:1}),a(R,{modelValue:F.value,"onUpdate:modelValue":o[1]||(o[1]=e=>F.value=e),"full-width":""},{default:t(()=>[a(z,{style:{"max-width":"1200px",margin:"0 auto"}},{default:t(()=>[a(w,{class:"row items-center"},{default:t(()=>[l("div",Ne,[l("div",Qe,d(p.value?.cliente_nombre||"-"),1),l("div",Te,d(p.value?.ci_nit||"-")+" - "+d(p.value?.telefono||"-"),1)]),g(a(b,{flat:"",icon:"close",round:"",dense:""},null,512),[[V]])]),_:1}),a(ve),a(w,null,{default:t(()=>[a(be,{dense:"",flat:"",bordered:"","wrap-cells":""},{default:t(()=>[o[23]||(o[23]=l("thead",null,[l("tr",null,[l("th",null,"Tipo"),l("th",null,"Referencia"),l("th",null,"Fecha"),l("th",null,"Total"),l("th",null,"Cobrado"),l("th",null,"Saldo"),l("th",null,"Estado"),l("th",null,"Acciones")])],-1)),l("tbody",null,[(m(!0),N(L,null,H(p.value?.items||[],e=>(m(),N(L,{key:`${e.tipo}-${e.id}`},[l("tr",null,[l("td",null,d(e.tipo),1),l("td",null,d(e.referencia),1),l("td",null,d(e.fecha||"-"),1),l("td",null,d(_(e.monto_total)),1),l("td",null,d(_(e.cobrado)),1),l("td",null,[a(C,{dense:"",color:Number(e.saldo||0)>0?"negative":"positive","text-color":"white"},{default:t(()=>[v(d(_(e.saldo)),1)]),_:2},1032,["color"])]),l("td",null,[a(C,{dense:"",color:e.considerar_en_cobranza?"blue-7":"grey-7","text-color":"white"},{default:t(()=>[v(d(e.considerar_en_cobranza?"En cobranza":"No considerar"),1)]),_:2},1032,["color"])]),l("td",null,[a(X,{dense:"",color:"primary","no-caps":"",label:"Opciones"},{default:t(()=>[a(W,null,{default:t(()=>[g((m(),h(S,{clickable:"",onClick:s=>B(e,null),disable:Number(e.saldo||0)<=0||!e.considerar_en_cobranza},{default:t(()=>[a(y,{avatar:""},{default:t(()=>[a($,{name:"payments"})]),_:1}),a(y,null,{default:t(()=>o[20]||(o[20]=[v("Pagar")])),_:1})]),_:2},1032,["onClick","disable"])),[[V]]),g((m(),h(S,{clickable:"",onClick:s=>B(e,G(e)),disable:!G(e)||!e.considerar_en_cobranza},{default:t(()=>[a(y,{avatar:""},{default:t(()=>[a($,{name:"edit"})]),_:1}),a(y,null,{default:t(()=>o[21]||(o[21]=[v("Modificar ultimo pago")])),_:1})]),_:2},1032,["onClick","disable"])),[[V]]),g((m(),h(S,{clickable:"",onClick:s=>se(e,!e.considerar_en_cobranza)},{default:t(()=>[a(y,{avatar:""},{default:t(()=>[a($,{name:"rule"})]),_:1}),a(y,null,{default:t(()=>[v(d(e.considerar_en_cobranza?"No considerar en cobranza":"Volver a considerar"),1)]),_:2},1024)]),_:2},1032,["onClick"])),[[V]])]),_:2},1024)]),_:2},1024)])]),l("tr",null,[l("td",Ue,[o[22]||(o[22]=l("div",{class:"text-caption text-grey-7 text-weight-bold q-mb-xs"},"Pagos:",-1)),(e.pagos||[]).length?A("",!0):(m(),N("div",ze,"Sin pagos")),(m(!0),N(L,null,H(e.pagos||[],s=>(m(),N("div",{key:`pg-${e.tipo}-${e.id}-${s.id}`,class:"row items-center no-wrap q-col-gutter-sm q-py-xs"},[l("div",Ae,"#"+d(s.id)+" - "+d(_(s.monto)),1),l("div",Se,[a(C,{dense:"",color:String(s.estado||"ACTIVO").toUpperCase()==="ANULADO"?"negative":"positive","text-color":"white"},{default:t(()=>[v(d(String(s.estado||"ACTIVO").toUpperCase()),1)]),_:2},1032,["color"])]),l("div",De,d(s.metodo_pago),1),l("div",Ie,d(s.nro_pago||"-"),1),l("div",Pe,d(s.fecha_hora||"-"),1),l("div",Oe,[v(d(s.registrado_por||"Sin usuario")+" ",1),s.anulado_por?(m(),N("div",Ee,"Anulado: "+d(s.anulado_por),1)):A("",!0)]),l("div",qe,[s.comprobante_url?(m(),h(b,{key:0,dense:"",flat:"",color:"primary",icon:"attach_file",label:"Ver comp.","no-caps":"",href:s.comprobante_url,target:"_blank"},null,8,["href"])):A("",!0),le(s.comprobante_url)?(m(),h(_e,{key:1,src:s.comprobante_url,style:{width:"28px",height:"28px","border-radius":"4px"},fit:"cover",class:"q-ml-xs"},null,8,["src"])):A("",!0)]),l("div",Fe,[String(s.estado||"ACTIVO").toUpperCase()!=="ANULADO"?(m(),h(b,{key:0,dense:"",flat:"",color:"negative",icon:"cancel",label:"Anular","no-caps":"",onClick:Z=>re(e,s)},null,8,["onClick"])):A("",!0)])]))),128))])])],64))),128))])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(R,{modelValue:D.value,"onUpdate:modelValue":o[7]||(o[7]=e=>D.value=e)},{default:t(()=>[a(z,{style:{width:"560px","max-width":"96vw"}},{default:t(()=>[a(w,{class:"row items-center q-pb-none"},{default:t(()=>[l("div",Me,d(x.value?"Modificar pago":"Registrar pago"),1),a(Y),g(a(b,{flat:"",dense:"",round:"",icon:"close"},null,512),[[V]])]),_:1}),a(w,null,{default:t(()=>[l("div",Be,d(U.value?.referencia||"-")+" - Saldo: "+d(_(U.value?.saldo||0)),1),l("div",Re,[l("div",Le,[a(f,{modelValue:i.value.monto,"onUpdate:modelValue":o[2]||(o[2]=e=>i.value.monto=e),modelModifiers:{number:!0},type:"number",min:"0.01",step:"0.01",dense:"",outlined:"",label:"Monto"},null,8,["modelValue"])]),l("div",je,[a(ee,{modelValue:i.value.metodo_pago,"onUpdate:modelValue":o[3]||(o[3]=e=>i.value.metodo_pago=e),options:ae,dense:"",outlined:"",label:"Metodo"},null,8,["modelValue"])]),l("div",Ge,[a(f,{modelValue:i.value.nro_pago,"onUpdate:modelValue":o[4]||(o[4]=e=>i.value.nro_pago=e),dense:"",outlined:"",label:"Nro pago"},null,8,["modelValue"])]),l("div",Ze,[a(f,{modelValue:i.value.observacion,"onUpdate:modelValue":o[5]||(o[5]=e=>i.value.observacion=e),dense:"",outlined:"",label:"Comentario"},null,8,["modelValue"])]),l("div",He,[a(ge,{modelValue:i.value.comprobante,"onUpdate:modelValue":o[6]||(o[6]=e=>i.value.comprobante=e),dense:"",outlined:"",label:"Foto/PDF comprobante",accept:".jpg,.jpeg,.png,.pdf"},null,8,["modelValue"])])])]),_:1}),a(J,{align:"right"},{default:t(()=>[g(a(b,{flat:"",color:"grey-8","no-caps":"",label:"Cancelar"},null,512),[[V]]),a(b,{color:"primary","no-caps":"",label:"Guardar",loading:E.value,onClick:de},null,8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(R,{modelValue:I.value,"onUpdate:modelValue":o[17]||(o[17]=e=>I.value=e)},{default:t(()=>[a(z,{style:{width:"680px","max-width":"96vw"}},{default:t(()=>[a(w,{class:"row items-center q-pb-none"},{default:t(()=>[o[24]||(o[24]=l("div",{class:"text-h6"},"Nueva deuda manual",-1)),a(Y),g(a(b,{flat:"",dense:"",round:"",icon:"close"},null,512),[[V]])]),_:1}),a(w,null,{default:t(()=>[l("div",Je,[l("div",Ke,[a(ee,{modelValue:u.value.cliente_id,"onUpdate:modelValue":o[8]||(o[8]=e=>u.value.cliente_id=e),options:M.value,"emit-value":"","map-options":"",dense:"",outlined:"","use-input":"","input-debounce":"300",onFilter:ie,label:"Cliente (opcional)",clearable:""},null,8,["modelValue","options"])]),l("div",We,[a(f,{modelValue:u.value.nombre_cliente,"onUpdate:modelValue":o[9]||(o[9]=e=>u.value.nombre_cliente=e),dense:"",outlined:"",label:"Nombre cliente (si es manual)"},null,8,["modelValue"])]),l("div",Xe,[a(f,{modelValue:u.value.ci_nit,"onUpdate:modelValue":o[10]||(o[10]=e=>u.value.ci_nit=e),dense:"",outlined:"",label:"CI/NIT"},null,8,["modelValue"])]),l("div",Ye,[a(f,{modelValue:u.value.telefono,"onUpdate:modelValue":o[11]||(o[11]=e=>u.value.telefono=e),dense:"",outlined:"",label:"Telefono"},null,8,["modelValue"])]),l("div",ea,[a(f,{modelValue:u.value.direccion,"onUpdate:modelValue":o[12]||(o[12]=e=>u.value.direccion=e),dense:"",outlined:"",label:"Direccion"},null,8,["modelValue"])]),l("div",aa,[a(f,{modelValue:u.value.monto_total,"onUpdate:modelValue":o[13]||(o[13]=e=>u.value.monto_total=e),modelModifiers:{number:!0},type:"number",min:"0.01",step:"0.01",dense:"",outlined:"",label:"Monto deuda"},null,8,["modelValue"])]),l("div",oa,[a(f,{modelValue:u.value.tolerancia_centavos,"onUpdate:modelValue":o[14]||(o[14]=e=>u.value.tolerancia_centavos=e),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",dense:"",outlined:"",label:"Tolerancia"},null,8,["modelValue"])]),l("div",la,[a(f,{modelValue:u.value.fecha,"onUpdate:modelValue":o[15]||(o[15]=e=>u.value.fecha=e),type:"date",dense:"",outlined:"",label:"Fecha"},null,8,["modelValue"])]),l("div",ta,[a(f,{modelValue:u.value.observacion,"onUpdate:modelValue":o[16]||(o[16]=e=>u.value.observacion=e),dense:"",outlined:"",label:"Observacion"},null,8,["modelValue"])])])]),_:1}),a(J,{align:"right"},{default:t(()=>[g(a(b,{flat:"",color:"grey-8","no-caps":"",label:"Cancelar"},null,512),[[V]]),a(b,{color:"positive","no-caps":"",label:"Crear deuda",loading:q.value,onClick:ce},null,8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}};export{Va as default};
