import{_ as Ne,g as we,r as m,x as ie,l as ke,p as Ee,m as xe,c as y,o as p,w as n,a as t,Q as B,e as q,b as i,aa as ae,d as x,f as $,a2 as c,t as s,h as $e,a6 as de,a3 as A,a4 as z,a5 as oe,Z as N,aR as Ae,a1 as Z,aC as Te,ac as Re}from"./index-CmoW1HI-.js";import{Q as O}from"./QChip-B_XB_8XG.js";import{Q as Se,a as H}from"./QTable-CP-Eucbl.js";import{a as P,b as g}from"./QMenu-j9-YnpjT.js";import{Q as De}from"./QList-MksEbVq0.js";import{Q as Oe,C as T}from"./ClosePopup-veQafRnd.js";import{Q as Pe}from"./QMarkupTable-6CKuV8-r.js";import{Q as Fe}from"./QPage-Dl-a7fNa.js";import{L as R}from"./leaflet-PeQDVTDL.js";import"./QSelect-YWvpHr97.js";import"./QItemLabel-BiiYZsTs.js";import"./format-CJebrXOQ.js";import"./_commonjsHelpers-Bx2EM-6T.js";const Me={class:"col-12 col-md-2"},Qe={class:"col-12 col-md-6"},Ve={class:"col-12 col-md-4"},Ie={class:"col-6 col-md-3"},Ue={class:"col-6 col-md-3"},Le={class:"col-6 col-md-3"},Ge={class:"col-6 col-md-3"},Be={class:"col"},qe={class:"text-subtitle1 text-weight-bold"},ze={class:"text-caption text-grey-7"},Ze={style:{"white-space":"nowrap"}},He={style:{width:"140px"}},je={colspan:"8",class:"bg-grey-1"},Ke={class:"q-mt-xs"},We={key:0,class:"text-caption text-grey-7"},Ye={__name:"RutasCamion",setup(Xe){const{proxy:u}=we(),j=m(new Date().toISOString().slice(0,10)),V=m(""),K=m(!1),w=m([]),F=m({}),I=m(!1),f=m(null),h=m([]),S=m({}),W=m({}),k=m({}),v=m(!1),b=m(!1),Y=m(null),D=m(null),U=m(null);let M=null;const re=[{name:"pedidos_count",label:"Pedidos",field:"pedidos_count",align:"left"},{name:"cliente",label:"Cliente",field:"cliente",align:"left"},{name:"tipo_pago_venta",label:"Tipo pago",field:"tipo_pago_venta",align:"left"},{name:"estado",label:"Estado",field:"despacho_estado",align:"left"},{name:"total",label:"Total",field:"total",align:"right"},{name:"pagado",label:"Cobrado",field:"pagado",align:"right"},{name:"saldo",label:"Saldo",field:"saldo",align:"right"}],se=["ENTREGADO","NO ENTREGADO","RECHAZADO"],X=ie(()=>!Array.isArray(h.value)||h.value.length===0?!0:h.value.some(o=>!se.includes(String(o.despacho_estado||"").toUpperCase()))),ue=ie(()=>{const o=new Map;return w.value.forEach(e=>{const a=e?.cliente_id?`cli-${e.cliente_id}`:`ped-${e.pedido_id}`,l=o.get(a)||{cliente_key:a,cliente_id:e.cliente_id,source_pedido_ids:[],cliente:e.cliente,telefono:e.telefono,direccion:e.direccion,latitud:e.latitud,longitud:e.longitud,pedidos_count:0,total:0,pagado:0,saldo:0,tipo_pago_venta:e.tipo_pago_venta||"",despacho_estado:e.despacho_estado||"PENDIENTE"};l.pedidos_count+=1,l.source_pedido_ids.push(e.pedido_id),l.total=Number(l.total)+Number(e.total||0),l.pagado=Number(l.pagado)+Number(e.pagado||0),l.saldo=Number(l.saldo)+Number(e.saldo||0),(String(l.tipo_pago_venta||"").toUpperCase().includes("CRED")||String(e.tipo_pago_venta||"").toUpperCase().includes("CRED"))&&(l.tipo_pago_venta="MIXTO/CREDITO"),l.despacho_estado=ce(l.despacho_estado,e.despacho_estado),o.set(a,l)}),Array.from(o.values()).map(e=>({...e,total:Number(e.total.toFixed(2)),pagado:Number(e.pagado.toFixed(2)),saldo:Number(e.saldo.toFixed(2))}))});function ce(o,e){const a={PENDIENTE:0,PARCIAL:1,"NO ENTREGADO":2,RECHAZADO:3,ENTREGADO:4},l=String(o||"PENDIENTE").toUpperCase(),d=String(e||"PENDIENTE").toUpperCase();return(a[d]??0)>(a[l]??0)?d:l}function E(o){return`Bs ${Number(o||0).toFixed(2)}`}function te(o){const e=String(o||"PENDIENTE").toUpperCase();return e==="ENTREGADO"?"green-7":e==="PARCIAL"?"orange-7":e==="NO ENTREGADO"?"amber-8":e==="RECHAZADO"?"negative":"blue-7"}function pe(){if(D.value||!Y.value)return;D.value=R.map(Y.value,{center:[-17.969721,-67.114493],zoom:12});const o=R.tileLayer("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}",{maxZoom:21,attribution:"Map data © Google"}),e=R.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{maxZoom:21,attribution:"Map data © Google"}),a=R.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",{maxZoom:21,attribution:"Map data © Google"});o.addTo(D.value),R.control.layers({"Google Calle":o,"Google Satelite":e,"Google Hibrido":a},{},{collapsed:!0}).addTo(D.value),U.value=R.layerGroup().addTo(D.value)}function me(){if(!U.value)return;U.value.clearLayers();const o=[],e=new Map;w.value.forEach(a=>{!a.cliente_id||!Number.isFinite(Number(a.latitud))||!Number.isFinite(Number(a.longitud))||e.has(a.cliente_id)||e.set(a.cliente_id,a)}),e.forEach(a=>{const l=Number(a.latitud),d=Number(a.longitud),r=R.marker([l,d]).addTo(U.value);r.bindTooltip(`${a.cliente||""}`,{sticky:!0}),r.on("click",()=>Q(a)),o.push([l,d])}),o.length&&D.value.fitBounds(o,{padding:[25,25],maxZoom:15})}async function C(){K.value=!0;try{const o=await u.$axios.get("/despachador/rutas",{params:{fecha:j.value,search:V.value||void 0}});w.value=Array.isArray(o.data?.data)?o.data.data.map(e=>({...e,pagoMonto:ee(e)})):[],F.value=o.data?.stats||{},me()}catch(o){u.$alert.error(o?.response?.data?.message||"No se pudo cargar rutas")}finally{K.value=!1}}function Q(o){f.value=o;const e=Array.isArray(o?.source_pedido_ids)?o.source_pedido_ids:[];h.value=w.value.filter(a=>e.length?e.includes(a.pedido_id):String(a.cliente_id)===String(o.cliente_id)).map(a=>({...a,pagoMonto:ee(a)})),S.value={},W.value={},I.value=!0}function ge(o){S.value[o]=!S.value[o]}function fe(o){if(!o)return;const e=Number(o.latitud),a=Number(o.longitud);if(!Number.isFinite(e)||!Number.isFinite(a)){u.$alert.error("El cliente no tiene ubicacion registrada");return}window.open(`https://www.google.com/maps/search/?api=1&query=${e},${a}`,"_blank")}function ve(){return new Promise(o=>{if(!navigator.geolocation)return o(null);navigator.geolocation.getCurrentPosition(e=>o({latitud:e.coords.latitude,longitud:e.coords.longitude}),()=>o(null),{enableHighAccuracy:!0,timeout:5e3,maximumAge:3e4})})}async function J(o,e=!0){const a=o?.pedido_id;k.value[a]=!0;try{const l=Number(Number(o.pagoMonto||0).toFixed(2));if(!Number.isFinite(l)||l<=0)return u.$alert.error("Monto invalido"),!1;const d=L(o);if(d)await u.$axios.put(`/despachador/pagos/${d}`,{monto:l});else{const r=await ve(),_=String(o.tipo_pago_venta||"CONTADO").toUpperCase().includes("CRED")?"CREDITO":"CONTADO";await u.$axios.post("/despachador/pagos",{venta_id:o.venta_id,monto:l,tipo_pago:_,metodo_pago:"EFECTIVO",observacion:null,latitud:r?.latitud,longitud:r?.longitud})}if(e&&(u.$alert.success("Cobro guardado"),await C(),f.value)){const r=w.value.find(_=>String(_.cliente_id)===String(f.value.cliente_id));r&&Q(r)}return!0}catch(l){return u.$alert.error(l?.response?.data?.message||"No se pudo registrar cobro"),!1}finally{k.value[a]=!1}}function L(o){const e=Array.isArray(o?.pagos)?o.pagos:[];return e.length&&e[e.length-1]?.id||null}function le(o){const e=Array.isArray(o?.pagos)?o.pagos:[];return e.length?Number(Number(e[e.length-1]?.monto||0).toFixed(2)):0}function ee(o){const e=le(o);if(e>0)return e;const a=Number(Number(o?.pagado||0).toFixed(2));return a>0?a:Number(Number(o?.saldo||0).toFixed(2))}async function be(o){const e=L(o);if(!e){u.$alert.error("No hay pago previo para modificar");return}const a=le(o),l=await new Promise(r=>{u.$q.dialog({title:"Modificar cobro",message:`Comanda #${o.comanda}`,prompt:{model:String(a),type:"number"},cancel:!0,persistent:!0}).onOk(_=>r(_)).onCancel(()=>r(null))});if(l===null)return;const d=Number(l);if(!Number.isFinite(d)||d<=0){u.$alert.error("Monto invalido");return}try{if(await u.$axios.put(`/despachador/pagos/${e}`,{monto:Number(d.toFixed(2))}),u.$alert.success("Cobro modificado"),await C(),f.value){const r=w.value.find(_=>String(_.cliente_id)===String(f.value.cliente_id));r&&Q(r)}}catch(r){u.$alert.error(r?.response?.data?.message||"No se pudo modificar el cobro")}}function _e(o,e){o&&(W.value[e]=o)}async function ne(o,e){if(!await J(o,!0))return;const l=W.value[e+1];l&&typeof l.focus=="function"&&l.focus()}async function ye(){v.value=!0;try{for(const o of h.value){const e=Number(Number(o.pagoMonto||0).toFixed(2)),a=!!L(o);if(e<=0&&a||e<=0&&!a)continue;if(!await J(o,!1))return}if(await C(),f.value){const o=w.value.find(e=>String(e.cliente_id)===String(f.value.cliente_id));if(o){Q(o);for(const e of h.value){const a=Number(Number(e.saldo||0).toFixed(2));e.pagoMonto=a>0?ee(e):0}}}await G("ENTREGADO")}finally{v.value=!1}}async function G(o){b.value=!0;try{await Promise.all(h.value.map(e=>u.$axios.put(`/despachador/pedidos/${e.pedido_id}/estado`,{estado:o}))),u.$alert.success("Estado actualizado"),await C(),I.value=!1}catch(e){u.$alert.error(e?.response?.data?.message||"No se pudo actualizar estado")}finally{b.value=!1}}async function he(o){try{const e=await u.$axios.get(`/despachador/reportes/vouchers/${o.venta_id}`,{responseType:"blob"}),a=new Blob([e.data],{type:"application/pdf"}),l=document.createElement("a"),d=window.URL.createObjectURL(a);l.href=d,l.download=`voucher_venta_${o.venta_id}.pdf`,document.body.appendChild(l),l.click(),l.remove(),window.URL.revokeObjectURL(d)}catch(e){u.$alert.error(e?.response?.data?.message||"No se pudo generar el voucher")}}async function Ce(o){try{const e=await u.$axios.get(`/despachador/reportes/vouchers/${o.venta_id}`,{responseType:"blob"}),a=new Blob([e.data],{type:"application/pdf"}),l=`voucher_venta_${o.venta_id}.pdf`,d=new File([a],l,{type:"application/pdf"});if(navigator.canShare&&navigator.canShare({files:[d]})){await navigator.share({files:[d],title:l});return}const r=document.createElement("a"),_=window.URL.createObjectURL(a);r.href=_,r.download=l,document.body.appendChild(r),r.click(),r.remove(),window.URL.revokeObjectURL(_),u.$alert.error("Tu navegador no permite compartir PDF directo. Se descargo el voucher.")}catch(e){u.$alert.error(e?.response?.data?.message||"No se pudo preparar el voucher")}}return ke(()=>{pe(),C()}),Ee(V,()=>{M&&clearTimeout(M),M=setTimeout(()=>C(),350)}),xe(()=>{M&&clearTimeout(M)}),(o,e)=>(p(),y(Fe,{class:"q-pa-sm rutas-page"},{default:n(()=>[t(B,{flat:"",bordered:"",class:"q-mb-sm"},{default:n(()=>[t(q,{class:"row q-col-gutter-sm items-center"},{default:n(()=>[i("div",Me,[t(ae,{modelValue:j.value,"onUpdate:modelValue":[e[0]||(e[0]=a=>j.value=a),C],type:"date",dense:"",outlined:"",label:"Fecha"},null,8,["modelValue"])]),i("div",Qe,[t(ae,{modelValue:V.value,"onUpdate:modelValue":e[1]||(e[1]=a=>V.value=a),dense:"",outlined:"",label:"Buscar cliente/comanda/producto",debounce:"250"},{append:n(()=>[t(x,{name:"search"})]),_:1},8,["modelValue"])]),i("div",Ve,[t($,{color:"primary",icon:"search","no-caps":"",class:"full-width",label:"Buscar",loading:K.value,onClick:C},null,8,["loading"])])]),_:1}),t(q,{class:"row q-col-gutter-sm q-pt-none"},{default:n(()=>[i("div",Ie,[t(O,{color:"blue-8","text-color":"white"},{default:n(()=>[c("Comandas: "+s(F.value.total_entregas||0),1)]),_:1})]),i("div",Ue,[t(O,{color:"indigo-8","text-color":"white"},{default:n(()=>[c("Total Bs: "+s(Number(F.value.monto_total||0).toFixed(2)),1)]),_:1})]),i("div",Le,[t(O,{color:"green-8","text-color":"white"},{default:n(()=>[c("Cobrado Bs: "+s(Number(F.value.monto_cobrado||0).toFixed(2)),1)]),_:1})]),i("div",Ge,[t(O,{color:"orange-8","text-color":"white"},{default:n(()=>[c("Saldo Bs: "+s(Number(F.value.saldo_total||0).toFixed(2)),1)]),_:1})])]),_:1})]),_:1}),t(B,{flat:"",bordered:"",class:"q-mb-sm"},{default:n(()=>[i("div",{ref_key:"mapRef",ref:Y,class:"map-container"},null,512)]),_:1}),t(B,{flat:"",bordered:""},{default:n(()=>[t(Se,{dense:"",flat:"","row-key":"cliente_key",rows:ue.value,columns:re,pagination:{rowsPerPage:0},onRowClick:e[2]||(e[2]=(a,l)=>Q(l))},{"body-cell-estado":n(a=>[t(H,{props:a},{default:n(()=>[t(O,{dense:"",color:te(a.row.despacho_estado),"text-color":"white"},{default:n(()=>[c(s(a.row.despacho_estado),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-total":n(a=>[t(H,{props:a},{default:n(()=>[c(s(E(a.row.total)),1)]),_:2},1032,["props"])]),"body-cell-pagado":n(a=>[t(H,{props:a},{default:n(()=>[c(s(E(a.row.pagado)),1)]),_:2},1032,["props"])]),"body-cell-saldo":n(a=>[t(H,{props:a},{default:n(()=>[c(s(E(a.row.saldo)),1)]),_:2},1032,["props"])]),_:1},8,["rows"])]),_:1}),t($e,{modelValue:I.value,"onUpdate:modelValue":e[7]||(e[7]=a=>I.value=a),"full-width":""},{default:n(()=>[t(B,{style:{"max-width":"1280px",margin:"0 auto"}},{default:n(()=>[t(q,{class:"row items-center"},{default:n(()=>[i("div",Be,[i("div",qe,s(f.value?.cliente||"-"),1),i("div",ze,s(f.value?.direccion||"-")+" · "+s(f.value?.telefono||"-"),1)]),t($,{color:"blue-7",icon:"map","no-caps":"",label:"Abrir mapa",onClick:e[3]||(e[3]=a=>fe(f.value))})]),_:1}),t(de),t(q,null,{default:n(()=>[t(Pe,{dense:"",flat:"",bordered:"","wrap-cells":""},{default:n(()=>[e[17]||(e[17]=i("thead",null,[i("tr",null,[i("th",null,"Acciones"),i("th",null,"Comanda"),i("th",null,"Importe"),i("th",null,"Pagado"),i("th",null,"Saldo"),i("th",null,"Tipo pago"),i("th",null,"Estado"),i("th",null,"Cobrado")])],-1)),i("tbody",null,[(p(!0),A(z,null,oe(h.value,(a,l)=>(p(),A(z,{key:a.pedido_id},[i("tr",null,[i("td",Ze,[t(Oe,{dense:"",color:"primary","no-caps":"",label:"Opciones",size:"sm",loading:!!k.value[a.pedido_id],disable:v.value||b.value},{default:n(()=>[t(De,null,{default:n(()=>[N((p(),y(P,{clickable:"",onClick:d=>ge(a.pedido_id)},{default:n(()=>[t(g,{avatar:""},{default:n(()=>[t(x,{name:S.value[a.pedido_id]?"visibility_off":"visibility"},null,8,["name"])]),_:2},1024),t(g,null,{default:n(()=>[c(s(S.value[a.pedido_id]?"Ocultar detalle":"Ver detalle"),1)]),_:2},1024)]),_:2},1032,["onClick"])),[[T]]),N((p(),y(P,{clickable:"",onClick:d=>J(a),disable:!a.venta_id||Number(a.saldo||0)<=0||v.value||b.value||!!k.value[a.pedido_id]},{default:n(()=>[t(g,{avatar:""},{default:n(()=>[t(x,{name:"payments"})]),_:1}),t(g,null,{default:n(()=>e[8]||(e[8]=[c("Cobrar")])),_:1})]),_:2},1032,["onClick","disable"])),[[T]]),N((p(),y(P,{clickable:"",onClick:d=>ne(a,l),disable:!a.venta_id||Number(a.saldo||0)<=0||v.value||b.value||!!k.value[a.pedido_id]},{default:n(()=>[t(g,{avatar:""},{default:n(()=>[t(x,{name:"arrow_downward"})]),_:1}),t(g,null,{default:n(()=>e[9]||(e[9]=[c("Siguiente")])),_:1})]),_:2},1032,["onClick","disable"])),[[T]]),N((p(),y(P,{clickable:"",onClick:d=>be(a),disable:!L(a)||v.value||b.value||!!k.value[a.pedido_id]},{default:n(()=>[t(g,{avatar:""},{default:n(()=>[t(x,{name:"edit"})]),_:1}),t(g,null,{default:n(()=>e[10]||(e[10]=[c("Modificar cobro")])),_:1})]),_:2},1032,["onClick","disable"])),[[T]]),N((p(),y(P,{clickable:"",onClick:d=>he(a),disable:!a.venta_id},{default:n(()=>[t(g,{avatar:""},{default:n(()=>[t(x,{name:"description"})]),_:1}),t(g,null,{default:n(()=>e[11]||(e[11]=[c("Voucher")])),_:1})]),_:2},1032,["onClick","disable"])),[[T]]),N((p(),y(P,{clickable:"",onClick:d=>Ce(a),disable:!a.venta_id},{default:n(()=>[t(g,{avatar:""},{default:n(()=>[t(x,{name:"chat"})]),_:1}),t(g,null,{default:n(()=>e[12]||(e[12]=[c("WhatsApp voucher")])),_:1})]),_:2},1032,["onClick","disable"])),[[T]])]),_:2},1024)]),_:2},1032,["loading","disable"])]),i("td",null,"#"+s(a.comanda),1),i("td",null,s(E(a.total)),1),i("td",null,s(E(a.pagado)),1),i("td",null,s(E(a.saldo)),1),i("td",null,s(a.tipo_pago_venta||"-"),1),i("td",null,[t(O,{dense:"",color:te(a.despacho_estado),"text-color":"white"},{default:n(()=>[c(s(a.despacho_estado),1)]),_:2},1032,["color"])]),i("td",He,[t(ae,{ref_for:!0,ref:d=>_e(d,l),modelValue:a.pagoMonto,"onUpdate:modelValue":d=>a.pagoMonto=d,modelModifiers:{number:!0},dense:"",outlined:"",type:"number",min:"0",step:"0.01",disable:v.value||b.value||!!k.value[a.pedido_id],onKeyup:Ae(d=>ne(a,l),["enter"])},null,8,["modelValue","onUpdate:modelValue","disable","onKeyup"])])]),N(i("tr",null,[i("td",je,[(p(!0),A(z,null,oe(a.productos||[],(d,r)=>(p(),A("div",{key:`${a.pedido_id}-${r}`,class:"q-py-xs"},[e[13]||(e[13]=i("b",null,"Codigo:",-1)),c(" "+s(d.codigo||"-")+" ",1),e[14]||(e[14]=i("b",null,"Producto:",-1)),c(" "+s(d.nombre||"-")+" ",1),e[15]||(e[15]=i("b",null,"Cant.:",-1)),c(" "+s(Number(d.cantidad||0).toFixed(2)),1)]))),128)),i("div",Ke,[e[16]||(e[16]=i("div",{class:"text-caption text-grey-7 text-weight-bold"},"Pagos registrados:",-1)),(a.pagos||[]).length?Z("",!0):(p(),A("div",We,"Sin pagos")),(p(!0),A(z,null,oe(a.pagos||[],d=>(p(),A("div",{key:`pg-${a.pedido_id}-${d.id}`,class:"text-caption"}," - Pago #"+s(d.id)+": "+s(E(d.monto)),1))),128))])])],512),[[Te,S.value[a.pedido_id]]])],64))),128))])]),_:1})]),_:1}),t(de),t(Re,{align:"right"},{default:n(()=>[t($,{color:"primary","no-caps":"",label:"Guardar todo y bloquear",loading:v.value,disable:b.value,onClick:ye},null,8,["loading","disable"]),X.value?(p(),y($,{key:0,color:"positive","no-caps":"",label:"Entregado",loading:b.value,disable:v.value,onClick:e[4]||(e[4]=a=>G("ENTREGADO"))},null,8,["loading","disable"])):Z("",!0),X.value?(p(),y($,{key:1,color:"amber-8","no-caps":"",label:"Volver mas tarde",loading:b.value,disable:v.value,onClick:e[5]||(e[5]=a=>G("NO ENTREGADO"))},null,8,["loading","disable"])):Z("",!0),X.value?(p(),y($,{key:2,color:"negative","no-caps":"",label:"Rechazado",loading:b.value,disable:v.value,onClick:e[6]||(e[6]=a=>G("RECHAZADO"))},null,8,["loading","disable"])):Z("",!0),N(t($,{flat:"","no-caps":"",color:"grey-8",label:"Cerrar"},null,512),[[T]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}},pa=Ne(Ye,[["__scopeId","data-v-bef784da"]]);export{pa as default};
