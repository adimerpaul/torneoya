import{Q as S}from"./QSpace-D9phzHsB.js";import{_ as I,c as g,o as c,w as o,a as s,Q as C,e as v,b as l,t as m,f as _,J as w,ao as N,H as D,I as b,ag as q,ap as y,G as n,F as Q,K as R,h as P,aa as M,aq as U}from"./index-BCqWixgG.js";import{Q as k}from"./QSelect-DrQ4uTqS.js";import{Q as G}from"./QBanner-B_-Jc-wH.js";import{Q as T}from"./QForm-BYazywih.js";import{Q as A}from"./QBadge-BcDNLmI8.js";import{Q as V}from"./QChip-Cr7WtGSR.js";import{e as z,Q as E,a as x,d as f}from"./format-DaA42lUg.js";import{Q as F}from"./QPage-CCnFDat8.js";import{C as L}from"./ClosePopup-Db419-hH.js";const j={name:"GraderiaForm",data(){return{loading:!1,loadingSeats:!1,showPreview:!0,seatDBMap:{},seatDialog:{open:!1,seat:null,seatStatus:"LIBRE",db:null},statusMeta:{LIBRE:{label:"Libre",color:"positive",bg:"#82f38b"},RESERVADO:{label:"Reservado",color:"warning",bg:"#f3d77d"},PAGADO:{label:"Pagado",color:"primary",bg:"#79bcee"},BLOQUEADO:{label:"Bloqueado",color:"negative",bg:"#ec7385"}},form:{nombre:"",direccion:"",filas:10,columnas:10,etiqueta_modo:"fila",start_top:!0,start_left:!0,activo:!0,regenerar_asientos:!1}}},computed:{isEdit(){return!!this.$route.params.id},totalAsientos(){const a=Number(this.form.filas||0),e=Number(this.form.columnas||0);return Math.max(0,a)*Math.max(0,e)},previewRows(){return Math.min(Number(this.form.filas||0),30)},previewCols(){return Math.min(Number(this.form.columnas||0),30)},previewSeats(){const a=this.previewRows,e=this.previewCols;if(a<=0||e<=0)return[];const d=this.form.start_top?this.range(1,a):this.range(1,a).reverse(),u=this.form.start_left?this.range(1,e):this.range(1,e).reverse(),t=[];for(const i of d){const r=[];for(const h of u){const p=this.makeCode(i,h),B=this.seatDBMap[p],O=this.normalizeEstado(B?.estado)||"LIBRE";r.push({code:p,r:i,c:h,fila:i,columna:h,status:O})}t.push(r)}return t}},watch:{"form.filas"(){this.seatDBMap={}},"form.columnas"(){this.seatDBMap={}},"form.etiqueta_modo"(){this.seatDBMap={}},"form.start_top"(){this.seatDBMap={}},"form.start_left"(){this.seatDBMap={}}},mounted(){this.isEdit&&this.getOne()},methods:{req(a){return a!=null&&a!==""||"Campo requerido"},normalizeEstado(a){if(!a)return"";const e=String(a).toUpperCase();return["LIBRE","RESERVADO","PAGADO","BLOQUEADO"].includes(e)?e:""},range(a,e){const d=[];for(let u=a;u<=e;u++)d.push(u);return d},numToLetters(a){let e="";for(a=Number(a);a>0;)a--,e=String.fromCharCode(65+a%26)+e,a=Math.floor(a/26);return e},makeCode(a,e){return this.form.etiqueta_modo==="fila"?`${this.numToLetters(a)}${e}`:`${this.numToLetters(e)}${a}`},openSeatDialog(a){const e=this.seatDBMap[a.code]||null,d=this.normalizeEstado(e?.estado)||a.status||"LIBRE";this.seatDialog.seat=a,this.seatDialog.db=e,this.seatDialog.seatStatus=d,this.seatDialog.open=!0},loadSeatsPreview(){if(!this.isEdit)return;this.loadingSeats=!0;const a=this.$route.params.id;this.$axios.get(`mis-graderias/${a}`,{params:{preview_rows:this.previewRows,preview_cols:this.previewCols}}).then(e=>{const d=e.data,u=d.graderia;this.form={nombre:u.nombre||"",direccion:u.direccion||"",filas:u.filas||1,columnas:u.columnas||1,etiqueta_modo:u.etiqueta_modo||"fila",start_top:!!u.start_top,start_left:!!u.start_left,activo:!!u.activo,regenerar_asientos:!1};const t={},i=d.asientos_preview||[];for(const r of i)t[r.codigo]=r;this.seatDBMap=t}).catch(e=>this.$alert.error(e.response?.data?.message||"No se pudo cargar asientos (preview)")).finally(()=>{this.loadingSeats=!1})},getOne(){this.loading=!0,this.$axios.get(`mis-graderias/${this.$route.params.id}`,{params:{preview_rows:this.previewRows,preview_cols:this.previewCols}}).then(a=>{const e=a.data,d=e.graderia;this.form={nombre:d.nombre||"",direccion:d.direccion||"",filas:d.filas||1,columnas:d.columnas||1,etiqueta_modo:d.etiqueta_modo||"fila",start_top:!!d.start_top,start_left:!!d.start_left,activo:!!d.activo,regenerar_asientos:!1};const u={},t=e.asientos_preview||[];for(const i of t)u[i.codigo]=i;this.seatDBMap=u}).catch(a=>this.$alert.error(a.response?.data?.message||"No se pudo cargar")).finally(()=>{this.loading=!1})},save(){if(this.isEdit&&this.form.regenerar_asientos){this.$q.dialog({title:"⚠️ Confirmar regeneración",message:`
        <div class="text-negative">
          <b>Esta acción eliminará TODOS los asientos existentes.</b><br><br>
          Se perderán reservas, pagos y clientes.<br>
          Todos los asientos volverán a estado <b>LIBRE</b>.<br><br>
          <b>¿Estás completamente seguro de continuar?</b>
        </div>
      `,html:!0,ok:{label:"Sí, regenerar asientos",color:"negative"},cancel:{label:"Cancelar",color:"grey"},persistent:!0}).onOk(()=>{this.doSave()});return}this.doSave()},doSave(){this.loading=!0;const a=this.$route.params.id,e={...this.form};(this.isEdit?this.$axios.put(`mis-graderias/${a}`,e):this.$axios.post("mis-graderias",e)).then(()=>{this.$alert.success(this.isEdit?"Gradería actualizada correctamente":"Gradería creada"),this.$router.push("/mis-graderias")}).catch(u=>{this.$alert.error(u.response?.data?.message||"No se pudo guardar")}).finally(()=>{this.loading=!1})}}},H={class:"text-subtitle1 text-weight-bold"},J={class:"text-caption text-grey-7"},K={class:"row q-col-gutter-xs"},X={class:"col-12 col-md-6"},Y={class:"col-12 col-md-6"},W={class:"col-6 col-md-2"},Z={class:"col-6 col-md-2"},$={class:"col-12 col-md-3"},ee={class:"col-12 col-md-3"},te={class:"col-6 col-md-2"},se={class:"col-6 col-md-2"},oe={key:0,class:"col-12"},le={class:"row justify-end q-gutter-sm q-mt-sm"},ae={class:"row items-center q-col-gutter-sm q-mb-sm"},re={class:"col-12 col-md-8"},ie={class:"text-caption text-grey-7"},ne={class:"col-12 col-md-4"},de={class:"row items-center justify-end q-gutter-xs"},ue={style:{width:"100%",overflow:"auto"}},me={border:"1",cellpadding:"6",cellspacing:"0",width:"100%"},ce=["bgcolor","onClick"],fe={style:{"font-size":"11px"}},pe={class:"text-subtitle1 text-weight-bold"},ge={class:"text-caption text-grey-7"};function be(a,e,d,u,t,i){return c(),g(F,{class:"q-pa-sm"},{default:o(()=>[s(C,{flat:"",bordered:""},{default:o(()=>[s(v,{class:"row items-center q-py-sm"},{default:o(()=>[l("div",null,[l("div",H,m(i.isEdit?"Editar Gradería":"Nueva Gradería"),1),l("div",J,m(i.isEdit?"Actualiza la gradería":"Crea la gradería y genera asientos automáticamente"),1)]),s(S),s(_,{flat:"",icon:"arrow_back",label:"Volver","no-caps":"",onClick:e[0]||(e[0]=r=>a.$router.push("/mis-graderias"))})]),_:1}),s(w),s(v,{class:"q-pa-sm"},{default:o(()=>[s(T,{onSubmit:N(i.save,["prevent"])},{default:o(()=>[l("div",K,[l("div",X,[s(q,{modelValue:t.form.nombre,"onUpdate:modelValue":e[1]||(e[1]=r=>t.form.nombre=r),label:"Nombre",dense:"",outlined:"",rules:[i.req]},null,8,["modelValue","rules"])]),l("div",Y,[s(q,{modelValue:t.form.direccion,"onUpdate:modelValue":e[2]||(e[2]=r=>t.form.direccion=r),label:"Dirección",dense:"",outlined:""},null,8,["modelValue"])]),l("div",W,[s(q,{modelValue:t.form.filas,"onUpdate:modelValue":e[3]||(e[3]=r=>t.form.filas=r),modelModifiers:{number:!0},type:"number",label:"Filas (X)",dense:"",outlined:"",rules:[i.req]},null,8,["modelValue","rules"])]),l("div",Z,[s(q,{modelValue:t.form.columnas,"onUpdate:modelValue":e[4]||(e[4]=r=>t.form.columnas=r),modelModifiers:{number:!0},type:"number",label:"Columnas (Y)",dense:"",outlined:"",rules:[i.req]},null,8,["modelValue","rules"])]),l("div",$,[s(k,{modelValue:t.form.etiqueta_modo,"onUpdate:modelValue":e[5]||(e[5]=r=>t.form.etiqueta_modo=r),dense:"",outlined:"",label:"Etiquetado",options:["fila","columna"],rules:[i.req]},null,8,["modelValue","rules"])]),l("div",ee,[s(k,{modelValue:t.form.activo,"onUpdate:modelValue":e[6]||(e[6]=r=>t.form.activo=r),dense:"",outlined:"",label:"Estado",options:[{label:"Activo",value:!0},{label:"Inactivo",value:!1}],"emit-value":"","map-options":""},null,8,["modelValue"])]),l("div",te,[s(y,{modelValue:t.form.start_top,"onUpdate:modelValue":e[7]||(e[7]=r=>t.form.start_top=r),label:"Empieza arriba"},null,8,["modelValue"])]),l("div",se,[s(y,{modelValue:t.form.start_left,"onUpdate:modelValue":e[8]||(e[8]=r=>t.form.start_left=r),label:"Empieza izquierda"},null,8,["modelValue"])]),i.isEdit?(c(),D("div",oe,[s(y,{modelValue:t.form.regenerar_asientos,"onUpdate:modelValue":e[9]||(e[9]=r=>t.form.regenerar_asientos=r),label:"Regenerar asientos (borra y crea de nuevo)",color:"negative"},null,8,["modelValue"]),t.form.regenerar_asientos?(c(),g(G,{key:0,class:"bg-red-1 text-negative q-mt-sm",dense:"",rounded:""},{default:o(()=>[...e[14]||(e[14]=[l("div",{class:"text-subtitle1 text-weight-bold"}," ⚠️ ADVERTENCIA IMPORTANTE ",-1),l("div",{class:"text-body2 q-mt-xs"},[n(" Al "),l("b",null,"regenerar los asientos"),n(": "),l("ul",{class:"q-mt-xs"},[l("li",null,[n("❌ Se eliminarán "),l("b",null,"todos los asientos existentes")]),l("li",null,[n("❌ Se perderán "),l("b",null,"reservas, pagos y clientes")]),l("li",null,[n("✔️ Todos los asientos volverán a estado "),l("b",null,"LIBRE")])]),l("b",null,"Esta acción no se puede deshacer.")],-1)])]),_:1})):b("",!0)])):b("",!0)]),l("div",le,[s(_,{color:"negative",label:"Cancelar","no-caps":"",flat:"",onClick:e[10]||(e[10]=r=>a.$router.push("/mis-graderias")),disable:t.loading},null,8,["disable"]),s(_,{color:"primary",label:i.isEdit?"Guardar":"Crear gradería","no-caps":"",type:"submit",loading:t.loading},null,8,["label","loading"])])]),_:1},8,["onSubmit"]),s(w,{class:"q-mt-md q-mb-md"}),s(C,{flat:"",bordered:"",class:"q-mt-sm"},{default:o(()=>[s(v,{class:"row items-center q-py-sm"},{default:o(()=>[e[15]||(e[15]=l("div",{class:"text-subtitle2 text-weight-bold"},"Vista previa de asientos",-1)),s(S),s(A,{outline:"",color:"primary",class:"q-mr-sm"},{default:o(()=>[n(" Total: "+m(i.totalAsientos),1)]),_:1}),i.isEdit?(c(),g(_,{key:0,dense:"","no-caps":"",color:"primary",icon:"refresh",label:"Recargar",loading:t.loadingSeats,onClick:e[11]||(e[11]=r=>i.loadSeatsPreview()),class:"q-mr-sm"},null,8,["loading"])):b("",!0),s(y,{modelValue:t.showPreview,"onUpdate:modelValue":e[12]||(e[12]=r=>t.showPreview=r),dense:"",label:"Mostrar"},null,8,["modelValue"])]),_:1}),s(w),t.showPreview?(c(),g(v,{key:0,class:"q-pa-sm"},{default:o(()=>[l("div",ae,[l("div",re,[l("div",ie,[n(" Preview limitado a "+m(i.previewRows)+" x "+m(i.previewCols)+". Click en un asiento ",1),e[16]||(e[16]=l("b",null,"LIBRE",-1)),e[17]||(e[17]=n(" para ver info en un diálogo. ",-1))])]),l("div",ne,[l("div",de,[s(V,{dense:"",color:t.statusMeta.LIBRE.color,"text-color":"white",icon:"event_seat"},{default:o(()=>[...e[18]||(e[18]=[n("LIBRE",-1)])]),_:1},8,["color"]),s(V,{dense:"",color:t.statusMeta.RESERVADO.color,"text-color":"white",icon:"bookmark"},{default:o(()=>[...e[19]||(e[19]=[n("RESERVADO",-1)])]),_:1},8,["color"]),s(V,{dense:"",color:t.statusMeta.PAGADO.color,"text-color":"white",icon:"paid"},{default:o(()=>[...e[20]||(e[20]=[n("PAGADO",-1)])]),_:1},8,["color"]),s(V,{dense:"",color:t.statusMeta.BLOQUEADO.color,"text-color":"white",icon:"block"},{default:o(()=>[...e[21]||(e[21]=[n("BLOQUEADO",-1)])]),_:1},8,["color"])])])]),l("div",ue,[l("table",me,[l("tbody",null,[(c(!0),D(Q,null,R(i.previewSeats,(r,h)=>(c(),D("tr",{key:h},[(c(!0),D(Q,null,R(r,p=>(c(),D("td",{key:p.code,bgcolor:t.statusMeta[p.status].bg,onClick:B=>i.openSeatDialog(p),style:{cursor:"pointer","text-align":"center"}},[l("div",null,[l("b",null,m(p.code),1)]),l("div",fe,m(t.statusMeta[p.status].label),1)],8,ce))),128))]))),128))])])])]),_:1})):b("",!0)]),_:1}),s(P,{modelValue:t.seatDialog.open,"onUpdate:modelValue":e[13]||(e[13]=r=>t.seatDialog.open=r)},{default:o(()=>[s(C,{style:{"min-width":"420px","max-width":"92vw"}},{default:o(()=>[s(v,{class:"row items-center q-py-sm"},{default:o(()=>[l("div",null,[l("div",pe," Asiento: "+m(t.seatDialog.seat?.code),1),l("div",ge," Fila: "+m(t.seatDialog.seat?.fila)+" — Columna: "+m(t.seatDialog.seat?.columna),1)]),s(S),M(s(_,{dense:"",flat:"",round:"",icon:"close"},null,512),[[L]])]),_:1}),s(w),s(v,{class:"q-pt-sm"},{default:o(()=>[s(A,{color:t.statusMeta[t.seatDialog.seatStatus].color,"text-color":"white",class:"q-mb-md"},{default:o(()=>[n(m(t.statusMeta[t.seatDialog.seatStatus].label),1)]),_:1},8,["color"]),s(z,{bordered:"",separator:""},{default:o(()=>[s(E,null,{default:o(()=>[s(x,null,{default:o(()=>[s(f,null,{default:o(()=>[...e[22]||(e[22]=[n("Descripción",-1)])]),_:1}),s(f,{caption:""},{default:o(()=>[n(m(t.seatDialog.db?.descripcion||"—"),1)]),_:1})]),_:1})]),_:1}),t.seatDialog.seatStatus!=="LIBRE"?(c(),g(E,{key:0},{default:o(()=>[s(x,null,{default:o(()=>[s(f,null,{default:o(()=>[...e[23]||(e[23]=[n("Cliente",-1)])]),_:1}),s(f,{caption:""},{default:o(()=>[n(m(t.seatDialog.db?.cliente_nombre||"—")+" — "+m(t.seatDialog.db?.cliente_celular||"—"),1)]),_:1})]),_:1})]),_:1})):b("",!0),t.seatDialog.seatStatus!=="LIBRE"?(c(),g(E,{key:1},{default:o(()=>[s(x,null,{default:o(()=>[s(f,null,{default:o(()=>[...e[24]||(e[24]=[n("Monto",-1)])]),_:1}),s(f,{caption:""},{default:o(()=>[n(m(t.seatDialog.db?.monto??"—"),1)]),_:1})]),_:1})]),_:1})):b("",!0),t.seatDialog.db?.reservado_at?(c(),g(E,{key:2},{default:o(()=>[s(x,null,{default:o(()=>[s(f,null,{default:o(()=>[...e[25]||(e[25]=[n("Reservado",-1)])]),_:1}),s(f,{caption:""},{default:o(()=>[n(m(t.seatDialog.db.reservado_at),1)]),_:1})]),_:1})]),_:1})):b("",!0),t.seatDialog.db?.pagado_at?(c(),g(E,{key:3},{default:o(()=>[s(x,null,{default:o(()=>[s(f,null,{default:o(()=>[...e[26]||(e[26]=[n("Pagado",-1)])]),_:1}),s(f,{caption:""},{default:o(()=>[n(m(t.seatDialog.db.pagado_at),1)]),_:1})]),_:1})]),_:1})):b("",!0)]),_:1}),e[27]||(e[27]=l("div",{class:"text-caption text-grey-7 q-mt-sm"}," * Este diálogo es solo informativo. La administración se hará en otra pantalla. ",-1))]),_:1}),s(w),s(U,{align:"right"},{default:o(()=>[M(s(_,{flat:"","no-caps":"",label:"Cerrar"},null,512),[[L]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})}const Se=I(j,[["render",be]]);export{Se as default};
