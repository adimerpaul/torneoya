import{Q as E}from"./QSpace-D9phzHsB.js";import{$ as Qe,ah as G,a0 as Te,ai as Se,a2 as De,g as Ue,r as Z,z as A,aj as Ee,a4 as Ae,ak as Oe,a7 as Ne,al as ze,p as X,m as Y,O as $,U as ee,am as Fe,j as se,an as Ge,ac as Ie,Z as je,_ as Be,c as m,o as n,w as a,a as s,Q as O,e as C,b as c,ag as w,d as b,H as _,I,F as j,K as B,G as g,t as x,ae as He,aa as Q,J as Le,f as p,h as H,ao as Me,ap as Re,aq as We}from"./index-BCqWixgG.js";import{v as Je,f as le,u as Ke,p as te,g as Ze,h as Xe,i as Ye,r as ae,s as $e,c as oe,e as ie,Q as P,a as f,d as T}from"./format-DaA42lUg.js";import{Q as es}from"./QBtnDropdown-C5qaIMi7.js";import{Q as ss,a as N}from"./QTable-Dacp_sJ1.js";import{Q as ls}from"./QImg-DbfNce7X.js";import{Q as re}from"./QChip-Cr7WtGSR.js";import{Q as ne}from"./QBadge-BcDNLmI8.js";import{Q as ts}from"./QSelect-DrQ4uTqS.js";import{Q as as}from"./QForm-BYazywih.js";import{Q as os}from"./QPage-CCnFDat8.js";import{C as S}from"./ClosePopup-Db419-hH.js";const is=Qe({name:"QTooltip",inheritAttrs:!1,props:{...Ke,...De,...G,maxHeight:{type:String,default:null},maxWidth:{type:String,default:null},transitionShow:{...G.transitionShow,default:"jump-down"},transitionHide:{...G.transitionHide,default:"jump-up"},anchor:{type:String,default:"bottom middle",validator:le},self:{type:String,default:"top middle",validator:le},offset:{type:Array,default:()=>[14,14],validator:Je},scrollTarget:Se,delay:{type:Number,default:0},hideDelay:{type:Number,default:0},persistent:Boolean},emits:[...Te],setup(t,{slots:e,emit:h,attrs:d}){let o,i;const l=Ue(),{proxy:{$q:r}}=l,y=Z(null),D=Z(!1),ue=A(()=>te(t.anchor,r.lang.rtl)),de=A(()=>te(t.self,r.lang.rtl)),me=A(()=>t.persistent!==!0),{registerTick:ce,removeTick:fe}=Ee(),{registerTimeout:U}=Ae(),{transitionProps:ge,transitionStyle:pe}=Oe(t),{localScrollTarget:L,changeScrollEvent:he,unconfigureScrollTarget:ve}=Ze(t,J),{anchorEl:v,canShow:be,anchorEvents:V}=Xe({showing:D,configureAnchorEl:Pe}),{show:we,hide:z}=Ne({showing:D,canShow:be,handleShow:ke,handleHide:Ce,hideOnRouteChange:me,processOnMount:!0});Object.assign(V,{delayShow:_e,delayHide:xe});const{showPortal:M,hidePortal:R,renderPortal:ye}=ze(l,y,qe,"tooltip");if(r.platform.is.mobile===!0){const u={anchorEl:v,innerRef:y,onClickOutside(k){return z(k),k.target.classList.contains("q-dialog__backdrop")&&je(k),!0}},F=A(()=>t.modelValue===null&&t.persistent!==!0&&D.value===!0);X(F,k=>{(k===!0?Ye:ae)(u)}),Y(()=>{ae(u)})}function ke(u){M(),ce(()=>{i=new MutationObserver(()=>q()),i.observe(y.value,{attributes:!1,childList:!0,characterData:!0,subtree:!0}),q(),J()}),o===void 0&&(o=X(()=>r.screen.width+"|"+r.screen.height+"|"+t.self+"|"+t.anchor+"|"+r.lang.rtl,q)),U(()=>{M(!0),h("show",u)},t.transitionDuration)}function Ce(u){fe(),R(),W(),U(()=>{R(!0),h("hide",u)},t.transitionDuration)}function W(){i!==void 0&&(i.disconnect(),i=void 0),o!==void 0&&(o(),o=void 0),ve(),$(V,"tooltipTemp")}function q(){$e({targetEl:y.value,offset:t.offset,anchorEl:v.value,anchorOrigin:ue.value,selfOrigin:de.value,maxHeight:t.maxHeight,maxWidth:t.maxWidth})}function _e(u){if(r.platform.is.mobile===!0){oe(),document.body.classList.add("non-selectable");const F=v.value,k=["touchmove","touchcancel","touchend","click"].map(K=>[F,K,"delayHide","passiveCapture"]);ee(V,"tooltipTemp",k)}U(()=>{we(u)},t.delay)}function xe(u){r.platform.is.mobile===!0&&($(V,"tooltipTemp"),oe(),setTimeout(()=>{document.body.classList.remove("non-selectable")},10)),U(()=>{z(u)},t.hideDelay)}function Pe(){if(t.noParentEvent===!0||v.value===null)return;const u=r.platform.is.mobile===!0?[[v.value,"touchstart","delayShow","passive"]]:[[v.value,"mouseenter","delayShow","passive"],[v.value,"mouseleave","delayHide","passive"]];ee(V,"anchor",u)}function J(){if(v.value!==null||t.scrollTarget!==void 0){L.value=Fe(v.value,t.scrollTarget);const u=t.noParentEvent===!0?q:z;he(L.value,u)}}function Ve(){return D.value===!0?se("div",{...d,ref:y,class:["q-tooltip q-tooltip--style q-position-engine no-pointer-events",d.class],style:[d.style,pe.value],role:"tooltip"},Ie(e.default)):null}function qe(){return se(Ge,ge.value,Ve)}return Y(W),Object.assign(l.proxy,{updatePosition:q}),ye}}),rs={name:"UsuariosPage",data(){return{users:[],user:{},userDialog:!1,loading:!1,filter:"",roles:["Administrador","Soporte","Operador","Cliente"],columns:[{name:"actions",label:"Acciones",align:"center"},{name:"avatar",label:"Avatar",align:"left",field:t=>t.avatar},{name:"name",label:"Nombre",align:"left",field:"name"},{name:"username",label:"Usuario",align:"left",field:"username"},{name:"email",label:"Email",align:"left",field:"email"},{name:"telefono_contacto_1",label:"Contacto 1",align:"left",field:"telefono_contacto_1"},{name:"telefono_contacto_2",label:"Contacto 2",align:"left",field:"telefono_contacto_2"},{name:"role",label:"Rol",align:"left",field:"role"},{name:"permissions",label:"Permisos",align:"left",field:t=>(t.permissions||[]).map(e=>e.name).join(", ")}],permissions:[],dialogPermisos:!1,permFilter:"",cambioAvatarDialogo:!1}},mounted(){this.usersGet()},computed:{filteredPermissions(){if(!this.permFilter)return this.permissions;const t=this.permFilter.toLowerCase();return this.permissions.filter(e=>e.name.toLowerCase().includes(t))}},methods:{req(t){return!!t||"Campo requerido"},imgUser(t){return`${this.$url}../../images/${t}`},userNew(){this.user={name:"",username:"",email:"",telefono_contacto_1:"",telefono_contacto_2:"",password:"",role:"Operador"},this.userDialog=!0},userEdit(t){this.user={...t,telefono_contacto_1:t.telefono_contacto_1||"",telefono_contacto_2:t.telefono_contacto_2||""},this.userDialog=!0},usersGet(){this.loading=!0,this.$axios.get("users").then(t=>{this.users=t.data}).catch(t=>this.$alert.error(t.response?.data?.message||"Error cargando usuarios")).finally(()=>{this.loading=!1})},userPost(){this.loading=!0,this.$axios.post("users",this.user).then(()=>{this.userDialog=!1,this.$alert.success("Usuario creado"),this.usersGet()}).catch(t=>this.$alert.error(t.response?.data?.message||"No se pudo crear")).finally(()=>{this.loading=!1})},userPut(){this.loading=!0,this.$axios.put(`users/${this.user.id}`,this.user).then(()=>{this.userDialog=!1,this.$alert.success("Usuario actualizado"),this.usersGet()}).catch(t=>this.$alert.error(t.response?.data?.message||"No se pudo actualizar")).finally(()=>{this.loading=!1})},userDelete(t){this.$alert.dialog("¿Desea eliminar el usuario?").onOk(()=>{this.loading=!0,this.$axios.delete(`users/${t}`).then(()=>{this.$alert.success("Usuario eliminado"),this.usersGet()}).catch(e=>this.$alert.error(e.response?.data?.message||"No se pudo eliminar")).finally(()=>{this.loading=!1})})},userEditPassword(t){this.user={...t},this.$alert.dialogPrompt("Nueva contraseña","Ingrese la nueva contraseña","password").onOk(e=>{this.loading=!0,this.$axios.put(`updatePassword/${t.id}`,{password:e}).then(()=>{this.$alert.success("Contraseña actualizada"),this.usersGet()}).catch(h=>this.$alert.error(h.response?.data?.message||"No se pudo actualizar")).finally(()=>{this.loading=!1})})},cambiarAvatar(t){this.user={...t},this.cambioAvatarDialogo=!0},onFileChange(t){const e=t.target.files[0];if(!e)return;const h=new FormData;h.append("avatar",e),this.loading=!0,this.$axios.post(`${this.user.id}/avatar`,h,{headers:{"Content-Type":"multipart/form-data"}}).then(()=>{this.cambioAvatarDialogo=!1,this.$alert.success("Avatar actualizado"),this.usersGet()}).catch(d=>this.$alert.error(d.response?.data?.message||"No se pudo subir avatar")).finally(()=>{this.loading=!1})},async permisosShow(t){this.user={...t},this.dialogPermisos=!0,this.loading=!0;try{const e=await this.$axios.get("permissions").then(d=>d.data),h=await this.$axios.get(`users/${t.id}/permissions`).then(d=>d.data);this.permissions=e.map(d=>({...d,checked:h.includes(d.id)}))}catch(e){this.$alert.error(e.response?.data?.message||"Error cargando permisos")}finally{this.loading=!1}},async permisosPost(){this.loading=!0;try{const t=this.permissions.filter(e=>e.checked).map(e=>e.id);await this.$axios.put(`users/${this.user.id}/permissions`,{permissions:t}),this.dialogPermisos=!1,this.$alert.success("Permisos actualizados"),this.usersGet()}catch(t){this.$alert.error(t.response?.data?.message||"No se pudo guardar permisos")}finally{this.loading=!1}}}},ns={class:"row items-center q-col-gutter-xs"},us={class:"text-left"},ds={class:"text-subtitle1 text-weight-bold"},ms={class:"row justify-end q-gutter-sm"},cs={class:"row items-start q-col-gutter-md"},fs={class:"col-12"},gs={class:"avatar-box"},ps=["src"],hs={key:1,class:"row items-center justify-center avatar-img"},vs={class:"row justify-end q-gutter-sm q-mt-md"};function bs(t,e,h,d,o,i){return n(),m(os,{class:"q-pa-md"},{default:a(()=>[s(O,{flat:"",bordered:"",class:"q-mb-md"},{default:a(()=>[s(C,{class:"row items-center"},{default:a(()=>[e[21]||(e[21]=c("div",null,[c("div",{class:"text-h6 text-title"},"Usuarios"),c("div",{class:"text-caption text-grey-7"},"Gestión de usuarios, roles, permisos y avatar")],-1)),s(E),s(w,{modelValue:o.filter,"onUpdate:modelValue":e[0]||(e[0]=l=>o.filter=l),label:"Buscar",dense:"",outlined:"",debounce:"300",style:{width:"280px"}},{append:a(()=>[s(b,{name:"search"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),s(ss,{rows:o.users,columns:o.columns,"row-key":"id",dense:"",flat:"",bordered:"","wrap-cells":"",filter:o.filter,"rows-per-page-options":[0],"loading-label":"Cargando...","no-data-label":"Sin registros"},{"top-right":a(()=>[s(p,{color:"positive",label:"Nuevo","no-caps":"",icon:"add_circle_outline",loading:o.loading,class:"q-mr-sm",onClick:i.userNew},null,8,["loading","onClick"]),s(p,{color:"primary",label:"Actualizar","no-caps":"",icon:"refresh",loading:o.loading,onClick:i.usersGet},null,8,["loading","onClick"])]),"body-cell-actions":a(l=>[s(N,{props:l,class:"text-center"},{default:a(()=>[s(es,{label:"Opciones","no-caps":"",size:"10px",dense:"",color:"primary"},{default:a(()=>[s(ie,null,{default:a(()=>[Q((n(),m(P,{clickable:"",onClick:r=>i.userEdit(l.row)},{default:a(()=>[s(f,{avatar:""},{default:a(()=>[s(b,{name:"edit"})]),_:1}),s(f,null,{default:a(()=>[s(T,null,{default:a(()=>[...e[22]||(e[22]=[g("Editar",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[S]]),Q((n(),m(P,{clickable:"",onClick:r=>i.userEditPassword(l.row)},{default:a(()=>[s(f,{avatar:""},{default:a(()=>[s(b,{name:"lock_reset"})]),_:1}),s(f,null,{default:a(()=>[s(T,null,{default:a(()=>[...e[23]||(e[23]=[g("Cambiar contraseña",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[S]]),Q((n(),m(P,{clickable:"",onClick:r=>i.cambiarAvatar(l.row)},{default:a(()=>[s(f,{avatar:""},{default:a(()=>[s(b,{name:"image"})]),_:1}),s(f,null,{default:a(()=>[s(T,null,{default:a(()=>[...e[24]||(e[24]=[g("Cambiar avatar",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[S]]),Q((n(),m(P,{clickable:"",onClick:r=>i.permisosShow(l.row)},{default:a(()=>[s(f,{avatar:""},{default:a(()=>[s(b,{name:"lock"})]),_:1}),s(f,null,{default:a(()=>[s(T,null,{default:a(()=>[...e[25]||(e[25]=[g("Permisos",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[S]]),s(Le),Q((n(),m(P,{clickable:"",onClick:r=>i.userDelete(l.row.id)},{default:a(()=>[s(f,{avatar:""},{default:a(()=>[s(b,{name:"delete"})]),_:1}),s(f,null,{default:a(()=>[s(T,null,{default:a(()=>[...e[26]||(e[26]=[g("Eliminar",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[S]])]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-avatar":a(l=>[s(N,{props:l},{default:a(()=>[s(He,{rounded:"",size:"42px"},{default:a(()=>[l.row.avatar?(n(),m(ls,{key:0,src:i.imgUser(l.row.avatar)},null,8,["src"])):(n(),m(b,{key:1,name:"person",size:"28px"}))]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-role":a(l=>[s(N,{props:l},{default:a(()=>[s(re,{label:l.row.role,color:t.$filters.color(l.row.role),"text-color":"white",dense:"",size:"13px"},null,8,["label","color"])]),_:2},1032,["props"])]),"body-cell-permissions":a(l=>[s(N,{props:l},{default:a(()=>[c("div",ns,[(n(!0),_(j,null,B((l.row.permissions||[]).slice(0,3),(r,y)=>(n(),m(re,{key:r.id||y,dense:"",color:"grey-3","text-color":"black",size:"12px",class:"q-mr-xs q-mb-xs"},{default:a(()=>[g(x(r.name),1)]),_:2},1024))),128)),(l.row.permissions||[]).length>3?(n(),m(ne,{key:0,outline:"",color:"primary",class:"q-ml-xs"},{default:a(()=>[g(" +"+x((l.row.permissions||[]).length-3)+" ",1),s(is,{anchor:"top middle",self:"bottom middle",offset:[0,8]},{default:a(()=>[c("div",us,[(n(!0),_(j,null,B(l.row.permissions,r=>(n(),_("div",{key:r.id},"• "+x(r.name),1))),128))])]),_:2},1024)]),_:2},1024)):I("",!0),(l.row.permissions||[]).length?I("",!0):(n(),m(ne,{key:1,color:"grey-5",outline:""},{default:a(()=>[...e[27]||(e[27]=[g(" Sin permisos ",-1)])]),_:1}))])]),_:2},1032,["props"])]),_:1},8,["rows","columns","filter"]),s(H,{modelValue:o.userDialog,"onUpdate:modelValue":e[11]||(e[11]=l=>o.userDialog=l),persistent:""},{default:a(()=>[s(O,{style:{width:"420px","max-width":"95vw"}},{default:a(()=>[s(C,{class:"row items-center q-pb-none"},{default:a(()=>[c("div",ds,x(o.user.id?"Editar usuario":"Nuevo usuario"),1),s(E),s(p,{icon:"close",flat:"",round:"",dense:"",onClick:e[1]||(e[1]=l=>o.userDialog=!1)})]),_:1}),s(C,{class:"q-pt-sm"},{default:a(()=>[s(as,{onSubmit:e[10]||(e[10]=Me(l=>o.user.id?i.userPut():i.userPost(),["prevent"]))},{default:a(()=>[s(w,{modelValue:o.user.name,"onUpdate:modelValue":e[2]||(e[2]=l=>o.user.name=l),label:"Nombre",dense:"",outlined:"",rules:[i.req],class:"q-mb-sm"},null,8,["modelValue","rules"]),s(w,{modelValue:o.user.username,"onUpdate:modelValue":e[3]||(e[3]=l=>o.user.username=l),label:"Usuario",dense:"",outlined:"",rules:[i.req],class:"q-mb-sm"},null,8,["modelValue","rules"]),s(w,{modelValue:o.user.email,"onUpdate:modelValue":e[4]||(e[4]=l=>o.user.email=l),label:"Email",dense:"",outlined:"",type:"email",class:"q-mb-sm"},null,8,["modelValue"]),s(w,{modelValue:o.user.telefono_contacto_1,"onUpdate:modelValue":e[5]||(e[5]=l=>o.user.telefono_contacto_1=l),label:"Teléfono de contacto 1",dense:"",outlined:"",class:"q-mb-sm"},null,8,["modelValue"]),s(w,{modelValue:o.user.telefono_contacto_2,"onUpdate:modelValue":e[6]||(e[6]=l=>o.user.telefono_contacto_2=l),label:"Teléfono de contacto 2",dense:"",outlined:"",class:"q-mb-sm"},null,8,["modelValue"]),o.user.id?I("",!0):(n(),m(w,{key:0,modelValue:o.user.password,"onUpdate:modelValue":e[7]||(e[7]=l=>o.user.password=l),label:"Contraseña",dense:"",outlined:"",type:"password",rules:[i.req],class:"q-mb-sm"},null,8,["modelValue","rules"])),s(ts,{modelValue:o.user.role,"onUpdate:modelValue":e[8]||(e[8]=l=>o.user.role=l),label:"Rol",dense:"",outlined:"",options:o.roles,rules:[i.req],class:"q-mb-md"},null,8,["modelValue","options","rules"]),c("div",ms,[s(p,{color:"negative",label:"Cancelar","no-caps":"",flat:"",onClick:e[9]||(e[9]=l=>o.userDialog=!1),disable:o.loading},null,8,["disable"]),s(p,{color:"primary",label:"Guardar","no-caps":"",type:"submit",loading:o.loading},null,8,["loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(H,{modelValue:o.cambioAvatarDialogo,"onUpdate:modelValue":e[16]||(e[16]=l=>o.cambioAvatarDialogo=l),persistent:""},{default:a(()=>[s(O,{style:{width:"420px","max-width":"95vw"}},{default:a(()=>[s(C,{class:"row items-center q-pb-none text-weight-bold"},{default:a(()=>[e[28]||(e[28]=g(" Cambiar avatar ",-1)),s(E),s(p,{icon:"close",flat:"",round:"",dense:"",onClick:e[12]||(e[12]=l=>o.cambioAvatarDialogo=!1)})]),_:1}),s(C,{class:"q-pt-sm"},{default:a(()=>[c("div",cs,[c("div",fs,[c("div",gs,[s(p,{icon:"edit",size:"10px",class:"absolute q-mt-sm q-ml-sm",onClick:e[13]||(e[13]=l=>t.$refs.fileInput.click()),dense:"",outline:"",label:"Cambiar foto","no-caps":""}),o.user.avatar?(n(),_("img",{key:0,src:i.imgUser(o.user.avatar),class:"avatar-img"},null,8,ps)):(n(),_("div",hs,[s(b,{name:"person",size:"88px"})])),c("input",{ref:"fileInput",type:"file",style:{display:"none"},onChange:e[14]||(e[14]=(...l)=>i.onFileChange&&i.onFileChange(...l)),accept:"image/*"},null,544)])])]),c("div",vs,[s(p,{color:"negative",label:"Cancelar","no-caps":"",flat:"",onClick:e[15]||(e[15]=l=>o.cambioAvatarDialogo=!1),disable:o.loading},null,8,["disable"])])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(H,{modelValue:o.dialogPermisos,"onUpdate:modelValue":e[20]||(e[20]=l=>o.dialogPermisos=l),persistent:""},{default:a(()=>[s(O,{style:{"min-width":"420px","max-width":"95vw"}},{default:a(()=>[s(C,{class:"row items-center q-pb-none text-weight-bold"},{default:a(()=>[g(" Permisos de "+x(o.user.username)+" ",1),s(E),s(p,{icon:"close",flat:"",round:"",dense:"",onClick:e[17]||(e[17]=l=>o.dialogPermisos=!1)})]),_:1}),s(C,{class:"q-pt-sm"},{default:a(()=>[s(w,{modelValue:o.permFilter,"onUpdate:modelValue":e[18]||(e[18]=l=>o.permFilter=l),dense:"",outlined:"",placeholder:"Filtrar permisos...",class:"q-mb-sm"},{append:a(()=>[s(b,{name:"search"})]),_:1},8,["modelValue"]),s(ie,{dense:"",bordered:"",class:"rounded-borders"},{default:a(()=>[(n(!0),_(j,null,B(i.filteredPermissions,l=>(n(),m(P,{key:l.id},{default:a(()=>[s(f,null,{default:a(()=>[g(x(l.name),1)]),_:2},1024),s(f,{side:""},{default:a(()=>[s(Re,{modelValue:l.checked,"onUpdate:modelValue":r=>l.checked=r},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),s(We,{align:"right"},{default:a(()=>[s(p,{color:"negative",label:"Cancelar","no-caps":"",flat:"",onClick:e[19]||(e[19]=l=>o.dialogPermisos=!1),disable:o.loading},null,8,["disable"]),s(p,{color:"primary",label:"Guardar","no-caps":"",onClick:i.permisosPost,loading:o.loading},null,8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const Ds=Be(rs,[["render",bs],["__scopeId","data-v-8ebc7b4a"]]);export{Ds as default};
