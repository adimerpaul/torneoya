import{Q as _}from"./QSpace-CEfCjwtz.js";import{_ as S,c as d,o as i,w as o,a as e,Q as k,e as g,b as u,ae as p,d as b,a9 as v,a8 as D,F as U,aa as F,a7 as f,t as h,ad as I,a3 as V,ab as B,f as n,h as q,af as T,ag as L,ah as N}from"./index-F1tR8Zd7.js";import{c as A,Q as C,a as c,b as x}from"./QList-BUnxxmyW.js";import{Q as j}from"./QBtnDropdown-BiDUwFlm.js";import{Q as R,a as Q,b as M}from"./QTable-D1f24TeV.js";import{Q as O}from"./QImg-Bw2ogfsS.js";import{Q as z}from"./format-Bg5lL9ZL.js";import{Q as H}from"./QTooltip-Gzh3foxh.js";import{Q as G}from"./QBadge-1g4bL-7t.js";import{Q as J}from"./QForm-CVZ3FBcu.js";import{Q as K}from"./QBanner-DxjzrRCy.js";import{Q as W}from"./QPage-DNKR3ZTb.js";import{C as P}from"./ClosePopup-K8h_zmlu.js";import"./position-engine-D-amRUn6.js";const X={name:"UsuariosPage",data(){return{users:[],user:{},userDialog:!1,loading:!1,filter:"",roles:["Administrador","Usuario"],columns:[{name:"actions",label:"Acciones",align:"center"},{name:"avatar",label:"Avatar",align:"left",field:r=>r.avatar},{name:"name",label:"Nombre",align:"left",field:"name"},{name:"username",label:"Usuario",align:"left",field:"username"},{name:"email",label:"Email",align:"left",field:"email"},{name:"telefono_contacto_1",label:"Contacto 1",align:"left",field:"telefono_contacto_1"},{name:"telefono_contacto_2",label:"Contacto 2",align:"left",field:"telefono_contacto_2"},{name:"role",label:"Rol",align:"left",field:"role"},{name:"permissions",label:"Permisos",align:"left",field:r=>(r.permissions||[]).map(s=>s.name).join(", ")}],permissions:[],dialogPermisos:!1,permFilter:"",cambioAvatarDialogo:!1,passwordDialog:!1,showPasswordNew:!1,showPasswordConfirm:!1,passwordForm:{password:"",password_confirmation:""}}},mounted(){this.usersGet()},computed:{filteredPermissions(){if(!this.permFilter)return this.permissions;const r=this.permFilter.toLowerCase();return this.permissions.filter(s=>s.name.toLowerCase().includes(r))}},methods:{req(r){return!!r||"Campo requerido"},imgUser(r){return`${this.$url}../../images/${r}`},userNew(){this.user={name:"",username:"",email:"",telefono_contacto_1:"",telefono_contacto_2:"",password:"",role:"Usuario"},this.userDialog=!0},userEdit(r){this.user={...r,telefono_contacto_1:r.telefono_contacto_1||"",telefono_contacto_2:r.telefono_contacto_2||""},this.userDialog=!0},usersGet(){this.loading=!0,this.$axios.get("users").then(r=>{this.users=r.data}).catch(r=>this.$alert.error(r.response?.data?.message||"Error cargando usuarios")).finally(()=>{this.loading=!1})},userPost(){this.loading=!0,this.$axios.post("users",this.user).then(()=>{this.userDialog=!1,this.$alert.success("Usuario creado"),this.usersGet()}).catch(r=>this.$alert.error(r.response?.data?.message||"No se pudo crear")).finally(()=>{this.loading=!1})},userPut(){this.loading=!0,this.$axios.put(`users/${this.user.id}`,this.user).then(()=>{this.userDialog=!1,this.$alert.success("Usuario actualizado"),this.usersGet()}).catch(r=>this.$alert.error(r.response?.data?.message||"No se pudo actualizar")).finally(()=>{this.loading=!1})},userDelete(r){this.$alert.dialog("¿Desea eliminar el usuario?").onOk(()=>{this.loading=!0,this.$axios.delete(`users/${r}`).then(()=>{this.$alert.success("Usuario eliminado"),this.usersGet()}).catch(s=>this.$alert.error(s.response?.data?.message||"No se pudo eliminar")).finally(()=>{this.loading=!1})})},userEditPassword(r){this.user={...r},this.passwordForm={password:"",password_confirmation:""},this.showPasswordNew=!0,this.showPasswordConfirm=!0,this.passwordDialog=!0},closePasswordDialog(){this.passwordDialog=!1,this.passwordForm={password:"",password_confirmation:""},this.showPasswordNew=!1,this.showPasswordConfirm=!1},passwordPut(){if(!this.passwordForm.password||this.passwordForm.password.length<6){this.$alert.error("La contrasena debe tener minimo 6 caracteres");return}if(this.passwordForm.password!==this.passwordForm.password_confirmation){this.$alert.error("La confirmacion no coincide");return}this.loading=!0,this.$axios.put(`updatePassword/${this.user.id}`,{password:this.passwordForm.password}).then(()=>{this.$alert.success("Contrasena actualizada"),this.closePasswordDialog(),this.usersGet()}).catch(r=>this.$alert.error(r.response?.data?.message||"No se pudo actualizar")).finally(()=>{this.loading=!1})},cambiarAvatar(r){this.user={...r},this.cambioAvatarDialogo=!0},onFileChange(r){const s=r.target.files[0];if(!s)return;const y=new FormData;y.append("avatar",s),this.loading=!0,this.$axios.post(`${this.user.id}/avatar`,y,{headers:{"Content-Type":"multipart/form-data"}}).then(()=>{this.cambioAvatarDialogo=!1,this.$alert.success("Avatar actualizado"),this.usersGet()}).catch(w=>this.$alert.error(w.response?.data?.message||"No se pudo subir avatar")).finally(()=>{this.loading=!1})},async permisosShow(r){this.user={...r},this.dialogPermisos=!0,this.loading=!0;try{const s=await this.$axios.get("permissions").then(w=>w.data),y=await this.$axios.get(`users/${r.id}/permissions`).then(w=>w.data);this.permissions=s.map(w=>({...w,checked:y.includes(w.id)}))}catch(s){this.$alert.error(s.response?.data?.message||"Error cargando permisos")}finally{this.loading=!1}},async permisosPost(){this.loading=!0;try{const r=this.permissions.filter(s=>s.checked).map(s=>s.id);await this.$axios.put(`users/${this.user.id}/permissions`,{permissions:r}),this.dialogPermisos=!1,this.$alert.success("Permisos actualizados"),this.usersGet()}catch(r){this.$alert.error(r.response?.data?.message||"No se pudo guardar permisos")}finally{this.loading=!1}}}},Y={class:"row items-center q-col-gutter-xs"},Z={class:"text-left"},$={class:"text-subtitle1 text-weight-bold"},ee={class:"row justify-end q-gutter-sm"},se={class:"row items-start q-col-gutter-md"},le={class:"col-12"},oe={class:"avatar-box"},ae=["src"],re={key:1,class:"row items-center justify-center avatar-img"},te={class:"row justify-end q-gutter-sm q-mt-md"},ie={class:"text-subtitle1 text-weight-bold"};function ne(r,s,y,w,a,t){return i(),d(W,{class:"q-pa-md"},{default:o(()=>[e(k,{flat:"",bordered:"",class:"q-mb-md"},{default:o(()=>[e(g,{class:"row items-center"},{default:o(()=>[s[26]||(s[26]=u("div",null,[u("div",{class:"text-h6 text-title"},"Usuarios"),u("div",{class:"text-caption text-grey-7"},"Gestión de usuarios, roles, permisos y avatar")],-1)),e(_),e(p,{modelValue:a.filter,"onUpdate:modelValue":s[0]||(s[0]=l=>a.filter=l),label:"Buscar",dense:"",outlined:"",debounce:"300",style:{width:"280px"},clearable:""},{append:o(()=>[e(b,{name:"search"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(R,{rows:a.users,columns:a.columns,"row-key":"id",dense:"",flat:"",bordered:"","wrap-cells":"",filter:a.filter,"rows-per-page-options":[0],"loading-label":"Cargando...","no-data-label":"Sin registros"},{"top-right":o(()=>[e(n,{color:"positive",label:"Nuevo","no-caps":"",icon:"add_circle_outline",loading:a.loading,class:"q-mr-sm",onClick:t.userNew},null,8,["loading","onClick"]),e(n,{color:"primary",label:"Actualizar","no-caps":"",icon:"refresh",loading:a.loading,onClick:t.usersGet},null,8,["loading","onClick"])]),"body-cell-actions":o(l=>[e(Q,{props:l,class:"text-center"},{default:o(()=>[e(j,{label:"Opciones","no-caps":"",size:"10px",dense:"",color:"primary"},{default:o(()=>[e(A,null,{default:o(()=>[V((i(),d(C,{clickable:"",onClick:m=>t.userEdit(l.row)},{default:o(()=>[e(c,{avatar:""},{default:o(()=>[e(b,{name:"edit"})]),_:1}),e(c,null,{default:o(()=>[e(x,null,{default:o(()=>[...s[27]||(s[27]=[f("Editar",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[P]]),V((i(),d(C,{clickable:"",onClick:m=>t.userEditPassword(l.row)},{default:o(()=>[e(c,{avatar:""},{default:o(()=>[e(b,{name:"lock_reset"})]),_:1}),e(c,null,{default:o(()=>[e(x,null,{default:o(()=>[...s[28]||(s[28]=[f("Cambiar contraseña",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[P]]),V((i(),d(C,{clickable:"",onClick:m=>t.cambiarAvatar(l.row)},{default:o(()=>[e(c,{avatar:""},{default:o(()=>[e(b,{name:"image"})]),_:1}),e(c,null,{default:o(()=>[e(x,null,{default:o(()=>[...s[29]||(s[29]=[f("Cambiar avatar",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[P]]),V((i(),d(C,{clickable:"",onClick:m=>t.permisosShow(l.row)},{default:o(()=>[e(c,{avatar:""},{default:o(()=>[e(b,{name:"lock"})]),_:1}),e(c,null,{default:o(()=>[e(x,null,{default:o(()=>[...s[30]||(s[30]=[f("Permisos",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[P]]),e(B),V((i(),d(C,{clickable:"",onClick:m=>t.userDelete(l.row.id)},{default:o(()=>[e(c,{avatar:""},{default:o(()=>[e(b,{name:"delete"})]),_:1}),e(c,null,{default:o(()=>[e(x,null,{default:o(()=>[...s[31]||(s[31]=[f("Eliminar",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[P]])]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-avatar":o(l=>[e(Q,{props:l},{default:o(()=>[e(I,{rounded:"",size:"42px"},{default:o(()=>[l.row.avatar?(i(),d(O,{key:0,src:t.imgUser(l.row.avatar)},null,8,["src"])):(i(),d(b,{key:1,name:"person",size:"28px"}))]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-role":o(l=>[e(Q,{props:l},{default:o(()=>[e(z,{label:l.row.role,color:r.$filters.color(l.row.role),"text-color":"white",dense:"",size:"13px"},null,8,["label","color"])]),_:2},1032,["props"])]),"body-cell-permissions":o(l=>[e(Q,{props:l},{default:o(()=>[u("div",Y,[(i(!0),v(U,null,F((l.row.permissions||[]).slice(0,3),(m,E)=>(i(),d(z,{key:m.id||E,dense:"",color:"grey-3","text-color":"black",size:"12px",class:"q-mr-xs q-mb-xs"},{default:o(()=>[f(h(m.name),1)]),_:2},1024))),128)),(l.row.permissions||[]).length>3?(i(),d(G,{key:0,outline:"",color:"primary",class:"q-ml-xs"},{default:o(()=>[f(" +"+h((l.row.permissions||[]).length-3)+" ",1),e(H,{anchor:"top middle",self:"bottom middle",offset:[0,8]},{default:o(()=>[u("div",Z,[(i(!0),v(U,null,F(l.row.permissions,m=>(i(),v("div",{key:m.id},"• "+h(m.name),1))),128))])]),_:2},1024)]),_:2},1024)):D("",!0),(l.row.permissions||[]).length?D("",!0):(i(),d(G,{key:1,color:"grey-5",outline:""},{default:o(()=>[...s[32]||(s[32]=[f(" Sin permisos ",-1)])]),_:1}))])]),_:2},1032,["props"])]),_:1},8,["rows","columns","filter"]),e(q,{modelValue:a.userDialog,"onUpdate:modelValue":s[11]||(s[11]=l=>a.userDialog=l),persistent:""},{default:o(()=>[e(k,{style:{width:"420px","max-width":"95vw"}},{default:o(()=>[e(g,{class:"row items-center q-pb-none"},{default:o(()=>[u("div",$,h(a.user.id?"Editar usuario":"Nuevo usuario"),1),e(_),e(n,{icon:"close",flat:"",round:"",dense:"",onClick:s[1]||(s[1]=l=>a.userDialog=!1)})]),_:1}),e(g,{class:"q-pt-sm"},{default:o(()=>[e(J,{onSubmit:s[10]||(s[10]=T(l=>a.user.id?t.userPut():t.userPost(),["prevent"]))},{default:o(()=>[e(p,{modelValue:a.user.name,"onUpdate:modelValue":s[2]||(s[2]=l=>a.user.name=l),label:"Nombre",dense:"",outlined:"",rules:[t.req],class:"q-mb-sm"},null,8,["modelValue","rules"]),e(p,{modelValue:a.user.username,"onUpdate:modelValue":s[3]||(s[3]=l=>a.user.username=l),label:"Usuario",dense:"",outlined:"",rules:[t.req],class:"q-mb-sm"},null,8,["modelValue","rules"]),e(p,{modelValue:a.user.email,"onUpdate:modelValue":s[4]||(s[4]=l=>a.user.email=l),label:"Email",dense:"",outlined:"",type:"email",class:"q-mb-sm"},null,8,["modelValue"]),e(p,{modelValue:a.user.telefono_contacto_1,"onUpdate:modelValue":s[5]||(s[5]=l=>a.user.telefono_contacto_1=l),label:"Teléfono de contacto 1",dense:"",outlined:"",class:"q-mb-sm"},null,8,["modelValue"]),e(p,{modelValue:a.user.telefono_contacto_2,"onUpdate:modelValue":s[6]||(s[6]=l=>a.user.telefono_contacto_2=l),label:"Teléfono de contacto 2",dense:"",outlined:"",class:"q-mb-sm"},null,8,["modelValue"]),a.user.id?D("",!0):(i(),d(p,{key:0,modelValue:a.user.password,"onUpdate:modelValue":s[7]||(s[7]=l=>a.user.password=l),label:"Contraseña",dense:"",outlined:"",type:"password",rules:[t.req],class:"q-mb-sm"},null,8,["modelValue","rules"])),e(M,{modelValue:a.user.role,"onUpdate:modelValue":s[8]||(s[8]=l=>a.user.role=l),label:"Rol",dense:"",outlined:"",options:a.roles,rules:[t.req],class:"q-mb-md"},null,8,["modelValue","options","rules"]),u("div",ee,[e(n,{color:"negative",label:"Cancelar","no-caps":"",flat:"",onClick:s[9]||(s[9]=l=>a.userDialog=!1),disable:a.loading},null,8,["disable"]),e(n,{color:"primary",label:"Guardar","no-caps":"",type:"submit",loading:a.loading},null,8,["loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(q,{modelValue:a.cambioAvatarDialogo,"onUpdate:modelValue":s[16]||(s[16]=l=>a.cambioAvatarDialogo=l),persistent:""},{default:o(()=>[e(k,{style:{width:"420px","max-width":"95vw"}},{default:o(()=>[e(g,{class:"row items-center q-pb-none text-weight-bold"},{default:o(()=>[s[33]||(s[33]=f(" Cambiar avatar ",-1)),e(_),e(n,{icon:"close",flat:"",round:"",dense:"",onClick:s[12]||(s[12]=l=>a.cambioAvatarDialogo=!1)})]),_:1}),e(g,{class:"q-pt-sm"},{default:o(()=>[u("div",se,[u("div",le,[u("div",oe,[e(n,{icon:"edit",size:"10px",class:"absolute q-mt-sm q-ml-sm",onClick:s[13]||(s[13]=l=>r.$refs.fileInput.click()),dense:"",outline:"",label:"Cambiar foto","no-caps":""}),a.user.avatar?(i(),v("img",{key:0,src:t.imgUser(a.user.avatar),class:"avatar-img"},null,8,ae)):(i(),v("div",re,[e(b,{name:"person",size:"88px"})])),u("input",{ref:"fileInput",type:"file",style:{display:"none"},onChange:s[14]||(s[14]=(...l)=>t.onFileChange&&t.onFileChange(...l)),accept:"image/*"},null,544)])])]),u("div",te,[e(n,{color:"negative",label:"Cancelar","no-caps":"",flat:"",onClick:s[15]||(s[15]=l=>a.cambioAvatarDialogo=!1),disable:a.loading},null,8,["disable"])])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(q,{modelValue:a.dialogPermisos,"onUpdate:modelValue":s[20]||(s[20]=l=>a.dialogPermisos=l),persistent:""},{default:o(()=>[e(k,{style:{"min-width":"420px","max-width":"95vw"}},{default:o(()=>[e(g,{class:"row items-center q-pb-none text-weight-bold"},{default:o(()=>[f(" Permisos de "+h(a.user.username)+" ",1),e(_),e(n,{icon:"close",flat:"",round:"",dense:"",onClick:s[17]||(s[17]=l=>a.dialogPermisos=!1)})]),_:1}),e(g,{class:"q-pt-sm"},{default:o(()=>[e(p,{modelValue:a.permFilter,"onUpdate:modelValue":s[18]||(s[18]=l=>a.permFilter=l),dense:"",outlined:"",placeholder:"Filtrar permisos...",class:"q-mb-sm"},{append:o(()=>[e(b,{name:"search"})]),_:1},8,["modelValue"]),e(A,{dense:"",bordered:"",class:"rounded-borders"},{default:o(()=>[(i(!0),v(U,null,F(t.filteredPermissions,l=>(i(),d(C,{key:l.id},{default:o(()=>[e(c,null,{default:o(()=>[f(h(l.name),1)]),_:2},1024),e(c,{side:""},{default:o(()=>[e(L,{modelValue:l.checked,"onUpdate:modelValue":m=>l.checked=m},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),e(N,{align:"right"},{default:o(()=>[e(n,{color:"negative",label:"Cancelar","no-caps":"",flat:"",onClick:s[19]||(s[19]=l=>a.dialogPermisos=!1),disable:a.loading},null,8,["disable"]),e(n,{color:"primary",label:"Guardar","no-caps":"",onClick:t.permisosPost,loading:a.loading},null,8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(q,{modelValue:a.passwordDialog,"onUpdate:modelValue":s[25]||(s[25]=l=>a.passwordDialog=l),persistent:""},{default:o(()=>[e(k,{style:{width:"430px","max-width":"95vw"}},{default:o(()=>[e(g,{class:"row items-center q-pb-none"},{default:o(()=>[u("div",ie," Cambiar contrasena de "+h(a.user.username||"usuario"),1),e(_),e(n,{icon:"close",flat:"",round:"",dense:"",onClick:t.closePasswordDialog},null,8,["onClick"])]),_:1}),e(g,{class:"q-pt-sm"},{default:o(()=>[e(p,{modelValue:a.passwordForm.password,"onUpdate:modelValue":s[22]||(s[22]=l=>a.passwordForm.password=l),label:"Nueva contrasena",dense:"",outlined:"",type:a.showPasswordNew?"text":"password",rules:[l=>l&&l.length>=6||"Minimo 6 caracteres"],class:"q-mb-sm"},{append:o(()=>[e(n,{dense:"",flat:"",round:"",type:"button",icon:a.showPasswordNew?"visibility":"visibility_off",onClick:s[21]||(s[21]=l=>a.showPasswordNew=!a.showPasswordNew)},null,8,["icon"])]),_:1},8,["modelValue","type","rules"]),e(p,{modelValue:a.passwordForm.password_confirmation,"onUpdate:modelValue":s[24]||(s[24]=l=>a.passwordForm.password_confirmation=l),label:"Confirmar contrasena",dense:"",outlined:"",type:a.showPasswordConfirm?"text":"password",rules:[l=>!!l||"Requerido",l=>l===a.passwordForm.password||"No coincide"],class:"q-mb-md"},{append:o(()=>[e(n,{dense:"",flat:"",round:"",type:"button",icon:a.showPasswordConfirm?"visibility":"visibility_off",onClick:s[23]||(s[23]=l=>a.showPasswordConfirm=!a.showPasswordConfirm)},null,8,["icon"])]),_:1},8,["modelValue","type","rules"]),e(K,{dense:"",rounded:"",class:"bg-grey-1 q-mb-sm"},{default:o(()=>[...s[34]||(s[34]=[f(" Se actualizara password y clave para este usuario. ",-1)])]),_:1})]),_:1}),e(N,{align:"right"},{default:o(()=>[e(n,{color:"negative",label:"Cancelar","no-caps":"",flat:"",onClick:t.closePasswordDialog,disable:a.loading},null,8,["onClick","disable"]),e(n,{color:"primary",label:"Guardar","no-caps":"",onClick:t.passwordPut,loading:a.loading},null,8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const ke=S(X,[["render",ne],["__scopeId","data-v-13c2ded3"]]);export{ke as default};
